
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>BLog</title>
	<meta name="author" content="Brian Leonard">

	
	<meta name="description" content="To my surprise, my daughter asked me if I would teach her how to build a web site today. She more or less wants a blog to keep track of what is &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="BLog" type="application/atom+xml">
	
	<link rel="canonical" href="http://bleonard.github.com/blog/page/2/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/assets/slides/css/for_blog.css">
	
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>

<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<a href="/"><img src="/images/dp.jpg" alt="Profile Picture" style="width: 160px;"></a>
</div>
<h1><a href="/">BLog</a></h1>
<p class="subtitle">Strong catchphrase situation here</p>
<p class="description">Chief Architect and Technical Co-founder of TaskRabbit - neighbors helping neighbors through technology.</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
	  
	  <a class="taskrabbit" href="http://www.taskrabbit.com" title="TaskRabbit">TaskRabbit</a>
	  
		
		
		
		<a class="github" href="https://github.com/bleonard" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/BrianL429">LinkedIn</a>
		
		
		<a class="twitter" href="http://twitter.com/bleonard" title="Twitter">Twitter</a>
		
		
		
		
		<a class="rss" href="/atom.xml" title="Feed">Feed</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-08-01T00:00:00-07:00" pubdate data-updated="true">Aug 1<span>st</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/css/'>css</a>, <a class='category' href='/blog/categories/home/'>home</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/08/01/teaching-css/">Teaching CSS</a></h1>
	<div class="entry-content">
		<p>To my surprise, my daughter asked me if I would teach her how to build a web site today. She more or less wants a blog to keep track of what is going on at a recess club she made at school: regular notes, calendar, things like that.</p>

<p>I had her draw out on paper what she wanted to build. It was interesting to see her reinvent the concept of a blog. For example, her first iteration only showed the post from &#8220;Today.&#8221; I asked her how you would see yesterday&#8217;s post. So she add a &#8220;Today&#8221; and a &#8220;Yesterday&#8221; button. So I asked her how to see the post from last week. Her answer was approximately, &#8220;Well, they just need to keep up!&#8221; However, she eventually conceded to a &#8220;Previous&#8221; and &#8220;Next&#8221; button.</p>

<p>Even on one&#8217;s first encounter, it seems that it&#8217;s impossible to teach this stuff without also teaching about concessions:</p>

<p><strong>Daughter</strong>: OK, here&#8217;s a picture of what I want to make (shows few buttons on top, content underneath)</p>

<p><strong>Dad</strong>: (Talks about closing and opening tags, gets a word on the page)</p>

<p><strong>Daughter</strong>: Make it bigger.</p>

<p><strong>Dad</strong>: (adds <code>h1</code> tag)</p>

<p><strong>Daughter</strong>: Add the other buttons.</p>

<p><strong>Dad</strong>: (adds two more <code>h1</code> tags)</p>

<p><strong>Daughter</strong>: Why are they not next to each other?</p>

<p><strong>Dad</strong>: (mumbles about <code>ul</code> and <code>li</code> - makes them a list)</p>

<p><strong>Daughter</strong>: Now they are too small again and have those dots.</p>

<p><strong>Dad</strong>: We need to &#8220;style&#8221; them. Let&#8217;s remove the dots. (inlines styles: <code>list-style-type:none;</code>)</p>

<p><strong>Daughter</strong>: OK. Now make it bigger again.</p>

<p><strong>Dad</strong>: (adds <code>font-size:50px;</code> to the first one) There.</p>

<p><strong>Daughter</strong>: What about the other ones?</p>

<p><strong>Dad</strong>: How do you think we make them bigger too?</p>

<p><strong>Daughter</strong>: (eventually adds inline style to other ones). Perfect! Now put them next to each other.</p>

<p><strong>Dad</strong>: (adds <code>display:inline;</code>)</p>

<p><strong>Daughter</strong>: You&#8217;re amazing! Ok, now make the background gold.</p>

<p><strong>Dad</strong>: (<code>background-color:Gold</code>)</p>

<p><strong>Daughter</strong>: That&#8217;s yellow.</p>

<p><strong>Dad</strong>: Here, look at <a href="http://www.w3schools.com/cssref/css_colornames.asp">this</a>.</p>

<p><strong>Daughter</strong>: Wow, so many choices! (picks GoldenRod)</p>

<p><strong>Dad</strong>: (shows how to change to that)</p>

<p><strong>Daughter</strong>: Perfect! Now make the buttons this one (points to DarkTorquise)</p>

<p><strong>Dad</strong>: (adds links makes them <code>background-color:DarkTurquoise;padding: 10px;</code>)</p>

<p><strong>Daughter</strong>: OK, let&#8217;s add the main words. In a white box.</p>

<p><strong>Dad</strong>: (adds <code>div</code> with <code>background-color:White;</code> and a few words)</p>

<p><strong>Daughter</strong>: Why is it so small?</p>

<p><strong>Dad</strong>: We need more words. (pastes Lorem Ipsum)</p>

<p><strong>Daughter</strong>: (not impressed) It needs to be bigger and in the middle.</p>

<p><strong>Dad</strong>: (adds <code>padding:20px;margin-left:auto;margin-right:auto;</code> to horizontally center content) How about that?</p>

<p><strong>Daughter</strong>: Also in the middle between the top and bottom.</p>

<p><strong>Dad</strong>: (sighs heavily. googles &#8220;vertical center div css&#8221; for the 100th time. reads for 7 minutes.)</p>

<p><strong>Daughter</strong>: What&#8217;s wrong?</p>

<p><strong>Dad</strong>: Are you sure you don&#8217;t want it near the top?</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-07-01T00:00:00-07:00" pubdate data-updated="true">Jul 1<span>st</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/business/'>business</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/07/01/okrs/">OKRs</a></h1>
	<div class="entry-content">
		<p>At <a href="http://www.taskrabbit.com">TaskRabbit</a>, we have something called Objectives and Key Results or <a href="https://en.wikipedia.org/wiki/OKR">OKRs</a> for short. Many companies do the same.</p>

<p>We&#8217;ve always talked about them as one thing. As in, &#8220;What&#8217;s the OKR?&#8221; That would more or less mean, &#8220;What number are we trying to hit?&#8221; An example would be getting better at fulfilling tasks by focusing on moving up the percentage of tasks that are posted and get successfully completed.</p>

<p>This metrics-driven approach can really work but its efficacy seems related to the metric chosen. If the team believes it&#8217;s the right number to move, it works out. If they see weird loopholes or tricks, then it is less effective. Because of this, there is much discussion each time about the best metric to focus upon. Assuming we don&#8217;t focus on something all-encompassing (&#8220;Revenue&#8221;), it often has turned out to be very difficult to find exactly the right metric.</p>

<p>My recent realization is that there are objectives <em>and</em> key results. Of course, that&#8217;s obvious because it&#8217;s the name of the thing. However, in my mind, I don&#8217;t think I ever separated them to the degree that they deserve to be separated. It was always about hitting the metric and that <em>was</em> the objective. The goal, as I now understand it, should be to make the objective more of the &#8220;intent&#8221; of the situation. The key result is simply a way to &#8220;sample&#8221; that intent.</p>

<h3>Example</h3>

<p>As an example, we could have an objective of &#8220;making TaskRabbit a habit.&#8221; I think it&#8217;s helpful to make it completely about the intent and not something like &#8220;increasing lifetime value&#8221; or &#8220;doubling monthly active users&#8221; or whatever. That helps when making decisions throughout the quarter and is open to interpretation as the understanding of it evolves. The key result, then, is for sampling the progress. It could be &#8220;increase the average number of tasks per month to X&#8221; or &#8220;get Y% more people to their 4th completed task,&#8221; or &#8220;increase the average number of consecutive weeks of usage to Z&#8221; or any number of other options.</p>

<p>Each metric will have its holes, but the best metrics will be the one or two that:</p>

<ul>
<li>are highly correlated to the intent of the objective</li>
<li>can be sampled frequently to understand and measure progress</li>
<li>are easily explainable and understandable to everyone</li>
</ul>


<p>This produces a metric that doesn&#8217;t have to have its nuances explained every time we talk about it, can be on the wall in dashboard form to see if it&#8217;s going well, and that we believe is a good enough sample of the goal.</p>


		
		<a href="/blog/2015/07/01/okrs/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-06-04T00:00:00-07:00" pubdate data-updated="true">Jun 4<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/math/'>math</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/06/04/big-decimal/">Big Decimal</a></h1>
	<div class="entry-content">
		<p>At <a href="http://www.taskrabbit.com">TaskRabbit</a>, people have hourly rates for the tasks that they do. They get paid based on the number of hours that they work.</p>

<p>We try to deal in base units to remove ambiguity. For example, we store the hourly rate in cents as an integer instead of in dollars as a double. Reporting time worked occurs in seconds. When that reporting occurs, there is a calculation to do to understand how much the Tasker needs to be paid. It might go something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FloatCalculator</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">hourly_rate_in_cents</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hourly_rate_in_cents</span> <span class="o">=</span> <span class="n">hourly_rate_in_cents</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">total_in_dollars</span><span class="p">(</span><span class="n">seconds_worked</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hours</span> <span class="o">=</span> <span class="n">seconds_worked</span> <span class="o">/</span> <span class="mi">3600</span><span class="o">.</span><span class="mi">0</span> <span class="c1"># seconds in an hour</span>
</span><span class='line'>    <span class="n">cents</span> <span class="o">=</span> <span class="vi">@hourly_rate_in_cents</span> <span class="o">*</span> <span class="n">hours</span>
</span><span class='line'>    <span class="n">dollars</span> <span class="o">=</span> <span class="n">cents</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1"># make it dollars</span>
</span><span class='line'>    <span class="n">dollars</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Over the years, we saw a few errors because of <a href="http://floating-point-gui.de/">limitations of floating point math</a>. Since then, we have switched to using <a href="http://ruby-doc.org/stdlib-2.1.5/libdoc/bigdecimal/rdoc/BigDecimal.html">BigDecimal</a> to prevent these kinds of errors.</p>

<p>There were no visible performance issues, but I recently got curious because all of the docs say that they are substantial. By writing the same calculator using BigDecimal, we can see the difference.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BigDecimalCalculator</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">hourly_rate_in_cents</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@hourly_rate_in_cents</span> <span class="o">=</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hourly_rate_in_cents</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">total_in_dollars</span><span class="p">(</span><span class="n">seconds_worked</span><span class="p">)</span>
</span><span class='line'>    <span class="n">hours</span> <span class="o">=</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">seconds_worked</span><span class="p">)</span> <span class="o">/</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cents</span> <span class="o">=</span> <span class="vi">@hourly_rate_in_cents</span> <span class="o">*</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dollars</span> <span class="o">=</span> <span class="n">cents</span> <span class="o">/</span> <span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>    <span class="n">dollars</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_f</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This does turn out to be significantly slower, so I also benchmarked marking the constants class level variables.</p>


		
		<a href="/blog/2015/06/04/big-decimal/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-04-02T00:00:00-07:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/queue/'>queue</a>, <a class='category' href='/blog/categories/resque/'>resque</a>, <a class='category' href='/blog/categories/sidekiq/'>sidekiq</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/04/02/queue-bus/">Queue Bus</a></h1>
	<div class="entry-content">
		<p>At <a href="http://www.taskrabbit.com">TaskRabbit</a>, we have been using <a href="/blog/2013/09/28/resque-bus/">resque-bus</a> for about two years. It has continued to provide value by  linking components via a loosely coupled publish/subscription model. We have seen 10x the number of events going through it, but have not yet hit any scaling issues. The benefit of using the tools we already have continues to be a huge win.</p>

<p>But other teams are using other tools like <a href="http://sidekiq.org/">Sidekiq</a>. We&#8217;re also interested in trying it out, but resque-bus (unsurprisingly) was tied closely to <a href="https://github.com/resque/resque">Resque</a>. We&#8217;ve changed that by creating <a href="https://github.com/queue-bus/queue-bus">queue-bus</a> and using an adapter pattern. There are now adapters in <a href="https://github.com/queue-bus/resque-bus">resque-bus</a> and <a href="https://github.com/queue-bus/sidekiq-bus">sidekiq-bus</a>, as well as a compatible version in <a href="https://github.com/queue-bus/node-queue-bus">node-queue-bus</a>.</p>

<p>The code interactions are basically the same but can work across systems. You can even have one app using Resque and one using Sidekiq.</p>

<h4>Pick your adapter</h4>

<p>By requiring one of the adapters, it automatically gets set up to be the one for the app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;sidekiq-bus&#39;</span> <span class="c1"># (or &#39;resque-bus&#39;)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Application A publishes an event</h4>

<p>Something happens in your application and you want to let the world know. In this case, you publish an event.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># business logic</span>
</span><span class='line'><span class="no">QueueBus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;user_created&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># or do it later</span>
</span><span class='line'><span class="no">QueueBus</span><span class="o">.</span><span class="n">publish_at</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">from_now</span><span class="p">,</span> <span class="s2">&quot;user_created&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Application B subscribes to events</h4>

<p>If the same or different application is interested when an event happens, it subscribes to it by name.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># initializer</span>
</span><span class='line'><span class="no">QueueBus</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;app_b&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">subscribe</span> <span class="s2">&quot;user_created&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>    <span class="c1"># business logic</span>
</span><span class='line'>    <span class="no">NameCount</span><span class="o">.</span><span class="n">find_or_create_by_name</span><span class="p">(</span><span class="n">attributes</span><span class="o">[</span><span class="s2">&quot;last_name&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">increment!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Upgrading</h3>

<p>The formats changed a little bit with the move. The last version that used the old format (0.3.7) also can adapt to the new format. This is important because you&#8217;ll have things in the queue during the transition.</p>

<p>Steps:</p>

<ul>
<li>Upgrade everyone to 0.3.7</li>
<li>Deploy all the things</li>
<li>Upgrade everyone to the newest version</li>
</ul>


<h3>More to come</h3>

<p>If people continue to like this approach and gem, we have lots of approaches and tools built on top of it that we&#8217;d be excited to make available. Let us know on <a href="https://github.com/queue-bus/queue-bus">Github</a> that you like it by watching, starring, or creating issues with questions, etc.</p>

<p>Now that we have the adapter pattern, also let us know if you are interested in making one for your background system of choice. A special thanks goes out to <a href="https://github.com/jonsgreen">Jonathan Greenberg</a> and the team at <a href="http://www.purpose.com/">purpose.com</a> who did just that to get this whole thing going.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-02-16T00:00:00-08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/apple/'>apple</a>, <a class='category' href='/blog/categories/dashboard/'>dashboard</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/02/16/apple-tv-dashboard/">Apple TV Dashboard</a></h1>
	<div class="entry-content">
		<p>So you have all these screens around and you want to have something awesome like on those one that Panic <a href="http://www.panic.com/blog/panic-status-board-2013-edition/">made</a>. You may also already have Apple TVs on these TVs because AirPlay is an effective way to project screens in an office full of Macs. This is position we were in at <a href="https://www.taskrabbit.com">TaskRabbit</a> and we&#8217;d tried a few things.</p>

<p>The most recent iteration was to have one Mac Mini in a closet and lots of very long wires into the TVs. It displayed a web page that cycled through the content. This wasn&#8217;t bad, but had a few issues. First, the screens all had to show the same thing. I wanted to be able to have different content on each. For example, in addition to key metrics, the conference rooms would have who had the room booked or the one by customer support would have more data on the call volume. But it just isn&#8217;t worth it to have 10 Mac Minis for this purpose. The other issue is that people still wanted to use Airplay, so they would switch the input and then not switch it back to the ambient content.</p>

<p>The solution seemed clear. I needed to get the dashboards to be the screensaver of an Apple TV.</p>

<h2>TLDR</h2>

<p><a href="https://github.com/bleonard/dashing_on_appletv">Here</a> is a sample project to ties all of this up into one package.</p>

<p>It uses the new gems, <a href="https://github.com/taskrabbit/dashing-screenshots">dashing-screenshots</a> and <a href="https://github.com/taskrabbit/icloud-photo">icloud-photo</a>, to take screenshots and upload them to iCloud. These then show up on an Apple TV</p>

<div class="jumbotron">
<img alt="Sample dashboard on the wall" src="/images/posts/appletv/sampletv.jpg" class="bigPicture" />
</div>


<p>(not actual dashboard)</p>

<p>To make this happen, check out the <a href="https://github.com/bleonard/dashing_on_appletv">project</a> and follow the instructions there.</p>

<h2>Dashboard</h2>

<p>Looking around at <a href="https://ducksboard.com/">various</a> <a href="https://www.geckoboard.com/">dashboard</a> <a href="http://panic.com/statusboard/">apps</a> and having made a few custom solutions, I settled on <a href="http://dashing.io/">Dashing</a> this time. It looked nice by default, had a great model for adding custom content, and is written in the language we tend to use around here (Ruby).</p>

<p>The Dashing <a href="http://dashing.io/#setup">docs</a> are quite good so I won&#8217;t go into detail of how we pulled in our data. The <a href="http://dashing.io/#widgets">samples</a> are actually the best as they show a simple use case of the pattern of how to add <code>jobs</code>. I made some helpers to be able to pull in data from <a href="http://www.looker.com/">Looker</a>. By putting the actual data in Looker, I&#8217;m hoping it will allow others to maintain the metrics definitions. This will hopefully keep the dashboard up to date and relevant. An issue we&#8217;ve had in the past is that the SQL became somewhat stale.</p>

<h2>Screenshots</h2>

<p>I&#8217;d like a fully dynamic dashboard as much as the next guy, but the screensaver of an Apple TV consists only of images. Therefore, the next step was to get a screenshot of all of the dashboards that Dashing has to offer. I have worked on a similar project within our test suite and had great success with <a href="https://rubygems.org/gems/selenium-webdriver">Selenium</a>. I added <code>selenium-webdriver</code> to the Gemfile and this file to <code>lib</code>.</p>


		
		<a href="/blog/2015/02/16/apple-tv-dashboard/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-06T00:00:00-08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/i18n/'>i18n</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/01/06/translating-rails-fields/">Translating Rails Fields</a></h1>
	<div class="entry-content">
		<p>When we launched <a href="https://www.taskrabbit.com">TaskRabbit</a> in London, one of our goals was to have a fully localized product. There are enough differences between British English and US English to not cut (m)any corners. Of course, it&#8217;s even more important in completely different languages.</p>

<p>An issue that I noticed one day was in our signup flow. It said &#8220;Last name is required.&#8221; This was caused by a blank field and a model-level validation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It was working as expected, but it should have said &#8220;Surname is required.&#8221; That&#8217;s what they want across the pond.</p>

<p>We translate all of our &#8220;en&#8221; locale into &#8220;en-GB&#8221; but this wasn&#8217;t there because it more or less works automatically. <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations.html">Active Model</a> does a <code>humanize</code> call on the field name. To translate this field, which we had done on stranger field names, you add it to a YML locale file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">activerecord</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">last_name</span><span class="p-Indicator">:</span> <span class="s">&#39;Last</span><span class="nv"> </span><span class="s">Name&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is for the one model, but there is <a href="https://github.com/rails/rails/blob/ebaf4e40cdcb80ebe16014a2c979f688213d7b92/activemodel/lib/active_model/translation.rb#L61">fallback code</a> in Active Model that also allows you to define the name for all models. You can do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">last_name</span><span class="p-Indicator">:</span> <span class="s">&#39;Last</span><span class="nv"> </span><span class="s">Name&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has the advantage of also working for another model as well as an Active Model <a href="https://blog.engineyard.com/2014/keeping-your-rails-controllers-dry-with-services">service objects</a> in one shot.</p>


		
		<a href="/blog/2015/01/06/translating-rails-fields/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-13T00:00:00-08:00" pubdate data-updated="true">Nov 13<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/database/'>database</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/11/13/rails-dead-columns/">Rails Dead Columns</a></h1>
	<div class="entry-content">
		<p>It happens. This column has to go. But in a <a href="http://rubyonrails.org/">Rails</a> app, there are a few problems. You can&#8217;t just drop it.</p>

<p>My first expectation is that we would create a <a href="http://guides.rubyonrails.org/migrations.html">migration</a> and do something like this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RemoveMiddleNameFromUsers &lt; ::ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    remove_column :users, :middle_name
</span><span class='line'>    remove_column :users, :gender
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>This will generally be fine but there are a few practical issues.</p>

<ul>
<li>Is any of my code still using this column?</li>
<li>What happens to the production code in the time between the migration and new code using it?</li>
</ul>


<h2>Still in use?</h2>

<p>The obvious thing to do is search the code for use of this column name, but sometimes that can be tricky. The name would be fairly common leading to difficult searching. You could also be accessing it in a fairly inconsistent way like via <code>send</code> and string interpolation or something.</p>

<p>The best way that we&#8217;ve found out that we are still using something is to freak out in test/development/staging if it is accessed. If we didn&#8217;t have the test coverage, we&#8217;d probably log it&#8217;s usage in production and check the logs for use.</p>


		
		<a href="/blog/2014/11/13/rails-dead-columns/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-07T00:00:00-08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/opensource/'>opensource</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/tools/'>tools</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/11/07/rails-stats/">Rails Stats</a></h1>
	<div class="entry-content">
		<p>Summary: I extracted and improved on the Rails stats tool. The code is <a href="https://github.com/bleonard/rails_stats/">here</a>.</p>

<h3>Process</h3>

<p>The other day, I was curious about how our codebase had evolved over the years and knew about the <code>rake stats</code> command in Rails. So I checked out a git sha from 2010 and ran the command. Of course the gems weren&#8217;t installed. So I ran <code>bundle install</code>. It said it couldn&#8217;t find <a href="gemcutter.org">gemcutter.org</a>. That&#8217;s when I knew it wasn&#8217;t going to work out. Even if I switched it to use current standards, at least one of those gems was going to be completely gone or a million of other issues.</p>

<p>I figured that an external tool to do the same thing should be easy and I was right. I copied the 3 files related to that rake job to a new project. The code just took directories in so the only dependence on being actually <em>in</em> the Rails project was a <code>Rails.root</code> call at the beginning. I switched it to be passed in from the command line and I was done!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |  1848 |  1483 |      32 |     174 |   5 |     6 |
</span><span class='line'>| Helpers              |  2257 |  1892 |      45 |     245 |   5 |     5 |
</span><span class='line'>| Models               |  4584 |  3509 |      61 |     526 |   8 |     4 |
</span><span class='line'>| Libraries            |  2987 |  2272 |      30 |     287 |   9 |     5 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                | 11676 |  9156 |     168 |    1232 |   7 |     5 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 9156     Test LOC: 0     Code to Test Ratio: 1:0.0
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; except things were missing. The tool that comes with Rails has a certain set of directories and it only looks for code there. It included the normal Rails stuff like models and controllers but was missing anything that strayed from the prescribed structure. These pieces were missing in the default tool:</p>

<ul>
<li>Anything added to the app directory (jobs, observers)</li>
<li>Rspec tests (it only supports Test::Unit)</li>
<li>Cucumber features</li>
<li>Any code in <a href="/blog/2014/02/11/rails-4-engines/">Engines</a></li>
</ul>


<p>It turned into a bit of time sink, but was a fun project. By modifying it to use more introspection of the directory structure, I was able to cover all the pieces of the app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>rake stats<span class="o">[</span>/path/to/app/<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Directory: /path/to/app/
</span><span class='line'>
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |  1848 |  1483 |      32 |     174 |   5 |     6 |
</span><span class='line'>| Helpers              |  2257 |  1892 |      45 |     245 |   5 |     5 |
</span><span class='line'>| Jobs                 |   399 |   295 |      11 |      33 |   3 |     6 |
</span><span class='line'>| Models               |  4584 |  3509 |      61 |     526 |   8 |     4 |
</span><span class='line'>| Observers            |    42 |    22 |       2 |       5 |   2 |     2 |
</span><span class='line'>| Libraries            |  2987 |  2272 |      30 |     287 |   9 |     5 |
</span><span class='line'>| Configuration        |  1233 |   669 |       4 |      17 |   4 |    37 |
</span><span class='line'>| Spec Support         |  1416 |  1152 |       4 |      30 |   7 |    36 |
</span><span class='line'>| Integration Tests    |    91 |    73 |       0 |       1 |   0 |    71 |
</span><span class='line'>| Lib Tests            |   101 |    83 |       0 |       1 |   0 |    81 |
</span><span class='line'>| Model Tests          |  3397 |  2522 |       0 |      18 |   0 |   138 |
</span><span class='line'>| Cucumber Support     |   739 |   521 |       0 |       1 |   0 |   519 |
</span><span class='line'>| Cucumber Features    |  2711 |  2487 |      29 |     145 |   5 |    15 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                | 21805 | 16980 |     218 |    1483 |   6 |     9 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 10142     Test LOC: 6838     Code to Test Ratio: 1:0.7
</span></code></pre></td></tr></table></div></figure>





		
		<a href="/blog/2014/11/07/rails-stats/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-10-30T00:00:00-07:00" pubdate data-updated="true">Oct 30<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/mysql/'>mysql</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/10/30/rails-schema-with-lhm/">Rails Schema With LHM</a></h1>
	<div class="entry-content">
		<p>At <a href="https://www.taskrabbit.com">TaskRabbit</a>, we like <a href="http://www.mysql.com/">MySQL</a>. As with everything, it has its own set of issues, though. One of these issues is that it locks the table while a column is added. This is not the biggest deal in the early days of a table, but once you start getting millions of rows and consistent traffic around the clock, this prevents the site from working as expected.</p>

<p>The first way that we worked around this problem was with the <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html">pt-online-schema-change</a> tool. It does the following:</p>

<ul>
<li>Makes a a new table with the old table&#8217;s schema</li>
<li>Copies data from the old table to the new table</li>
<li>Sets up a trigger for data to keep syncing</li>
<li>Adds the column to the new table</li>
<li>Renames the old table to something else and renames the new table to replace it</li>
<li>Deletes the old table</li>
</ul>


<p>This worked quite well, but had a flaw within our process. It was outside of the development and deployment workflow. In order to develop, we would still make a <a href="http://guides.rubyonrails.org/migrations.html">Rails migration</a>. Then just before deploy, we would run the tool and add the row to the <code>schema_migrations</code> table. When we deploy, it runs migrations, but in this case it would not run because we had added that row. I don&#8217;t think we ever messed it up, but the process had a few gaps.</p>

<p>We now use <a href="https://github.com/soundcloud/lhm">LHM</a> also known as Large Hadron Migrator from the good folks at <a href="https://soundcloud.com/">soundcloud</a>. It does basically the same thing, but allows you to do it right there in the migration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;lhm&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">AddMiddleNameToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="no">Lhm</span><span class="o">.</span><span class="n">change_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class='line'>      <span class="c1"># same as: add_column :users, :middle_name</span>
</span><span class='line'>      <span class="n">m</span><span class="o">.</span><span class="n">add_column</span> <span class="ss">:middle_name</span><span class="p">,</span> <span class="s2">&quot;VARCHAR(191) DEFAULT NULL&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this is great. Now it&#8217;s in the process.</p>

<h3>Schema</h3>

<p>One design choice (and it seems like the right one) is that it makes the last step manual. That is, it leaves the old (renamed) table around. We go back and delete these from production when sure everything worked out. The above migration might leave around a table named something like this: <code>lhma_2014_10_28_20_41_56_933_users</code>.</p>

<p>So that&#8217;s fine, but you&#8217;ll notice that when you run <code>rake db:migrate</code> that your <code>schema.rb</code> file now has that table in it. This happens because ActiveRecord takes a snapshot of your database right after the migration. We try to take really good care of our schema file, so this made us sad.</p>

<p>I went poking around in the ActiveRecord code ready to monkey patch the adapter that reads the table list or the code that generates the schema file. When I got there, though, I found there was already a class setting that did what I wanted. It even took a regex!</p>

<p>So here&#8217;s what to add if you don&#8217;t want those tables showing up in your schema file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/active_record_schema.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ignore LHM</span>
</span><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SchemaDumper</span><span class="o">.</span><span class="n">ignore_tables</span> <span class="o">&lt;&lt;</span> <span class="sr">/^lhma_/</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. Happy migrating.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-09-24T00:00:00-07:00" pubdate data-updated="true">Sep 24<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/blog/categories/geohash/'>geohash</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/09/24/geohashes/">Geohashes</a></h1>
	<div class="entry-content">
		<p>Over the years, we&#8217;ve struggled at <a href="https://www.taskrabbit.com">TaskRabbit</a> with a way to represent smaller geographic areas. Postal codes seems to be the most obvious but these vary dramatically in size. For example, there are postal codes that are just one building and ones that are bigger than some US states. We&#8217;ve also tried &#8220;neighborhood&#8221; data from various sources, but these are somewhat unreliable.</p>

<p>I recently learned about and started using <a href="http://en.wikipedia.org/wiki/Geohash">geohashes</a> to break the world into boxes and have been very happy with the results. I gave a lightning talk last week at <a href="http://gogaruco.com/">GoGaRuCo</a> on the subject. Many of them had heard about it, but the talk went over fairly well.</p>

<h3>Use Case</h3>

<p>The problem at hand is one of probabilities. Given a task, who are the best taskers for the job. Or conversely, given a tasker, what are the best few tasks for them. Taskers give us an idea of where they want to work but actions often speak louder than <s>words</s> user-drawn geographic polygons. So what I wanted to do was map their history into positive and negative areas of probability depending on what tasks they wanted to do and which they did not.</p>

<p>I had all those points and it was fairly easy to draw a heatmap using <a href="https://www.mapbox.com/mapbox.js/example/v1.0.0/leaflet-heat/">this Leaflet plugin</a>, but that needed to be mapped to something more concrete. We would be using <a href="http://www.elasticsearch.org/">Elasticsearch</a> for the storage, so while researching it&#8217;s geo functions, I stumbled across the concept of <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geohashgrid-aggregation.html">geohashes</a> which it evidently uses internally for such queries.</p>

<p><a href="http://www.bigfastblog.com/geohash-intro">This</a> article gives a really good explanation of how it works. The short version is that if you were to start with the whole world and keep cutting it in half depending on where your lat/lng was, you&#8217;d end up with a lot of left/right (or top/bottom) choices. Those choices can be encoded into binary, which can be encoded into a simple string. So this spot in London (51.507794, -0.127952) would become the &#8220;gcpvj0dyds&#8221; geohash. It has the interesting property that strings (locations) that have the same start are known to be close to it. For example, the &#8220;gcpvj09swr&#8221; geohash has the first six characters in common, so we would know that is within half a mile or so of the first one.</p>

<p>So now I have all of these points. I can map them to geohashes of the necessary precision (I chose 6) and give positive and negative weights for each user action. The actual calculation turns out to be really fast. I used the code from the <a href="https://github.com/masuidrive/pr_geohash/blob/master/lib/pr_geohash.rb">pr_geohash</a> gem and had no issues. It also calculates neighbors which turns out the be important.</p>

<p>Using the weight, I can combine and draw the geohashes (<a href="https://github.com/rgeo/rgeo">RGeo</a>/<a href="http://leafletjs.com/">Leaflet</a>). As an example, here is drawing where a particular Tasker is likely to want to work:</p>

<p><img src="/images/posts/geohashes/medium.jpg" alt="Likely to Accept" /></p>


		
		<a href="/blog/2014/09/24/geohashes/" class="more-link">Read on &rarr;</a>
	</div>

</article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Brian Leonard

</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'bleonard';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



		</div>
	</div>
</body>
</html>
