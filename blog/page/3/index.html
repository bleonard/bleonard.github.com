
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>BLog</title>
	<meta name="author" content="Brian Leonard">

	
	<meta name="description" content="It happens. This column has to go. But in a Rails app, there are a few problems. You can&#8217;t just drop it. My first expectation is that we would &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="BLog" type="application/atom+xml">
	
	<link rel="canonical" href="http://bleonard.github.io/blog/page/3/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/assets/slides/css/for_blog.css">
	
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>

<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<a href="/"><img src="/images/dp.jpg" alt="Profile Picture" style="width: 160px;"></a>
</div>
<h1><a href="/">BLog</a></h1>
<p class="subtitle">Strong catchphrase situation here</p>
<p class="description">Chief Architect and Technical Co-founder of TaskRabbit - neighbors helping neighbors through technology.</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
	  
	  <a class="taskrabbit" href="http://www.taskrabbit.com" title="TaskRabbit">TaskRabbit</a>
	  
		
		
		
		<a class="github" href="https://github.com/bleonard" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/BrianL429">LinkedIn</a>
		
		
		<a class="twitter" href="http://twitter.com/bleonard" title="Twitter">Twitter</a>
		
		
		
		
		<a class="rss" href="/atom.xml" title="Feed">Feed</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-13T00:00:00-08:00" pubdate data-updated="true">Nov 13<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/database/'>database</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/11/13/rails-dead-columns/">Rails Dead Columns</a></h1>
	<div class="entry-content">
		<p>It happens. This column has to go. But in a <a href="http://rubyonrails.org/">Rails</a> app, there are a few problems. You can&#8217;t just drop it.</p>

<p>My first expectation is that we would create a <a href="http://guides.rubyonrails.org/migrations.html">migration</a> and do something like this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RemoveMiddleNameFromUsers &lt; ::ActiveRecord::Migration
</span><span class='line'>  def change
</span><span class='line'>    remove_column :users, :middle_name
</span><span class='line'>    remove_column :users, :gender
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>This will generally be fine but there are a few practical issues.</p>

<ul>
<li>Is any of my code still using this column?</li>
<li>What happens to the production code in the time between the migration and new code using it?</li>
</ul>


<h2>Still in use?</h2>

<p>The obvious thing to do is search the code for use of this column name, but sometimes that can be tricky. The name would be fairly common leading to difficult searching. You could also be accessing it in a fairly inconsistent way like via <code>send</code> and string interpolation or something.</p>

<p>The best way that we&#8217;ve found out that we are still using something is to freak out in test/development/staging if it is accessed. If we didn&#8217;t have the test coverage, we&#8217;d probably log it&#8217;s usage in production and check the logs for use.</p>


		
		<a href="/blog/2014/11/13/rails-dead-columns/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-07T00:00:00-08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/opensource/'>opensource</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/tools/'>tools</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/11/07/rails-stats/">Rails Stats</a></h1>
	<div class="entry-content">
		<p>Summary: I extracted and improved on the Rails stats tool. The code is <a href="https://github.com/bleonard/rails_stats/">here</a>.</p>

<h3>Process</h3>

<p>The other day, I was curious about how our codebase had evolved over the years and knew about the <code>rake stats</code> command in Rails. So I checked out a git sha from 2010 and ran the command. Of course the gems weren&#8217;t installed. So I ran <code>bundle install</code>. It said it couldn&#8217;t find <a href="gemcutter.org">gemcutter.org</a>. That&#8217;s when I knew it wasn&#8217;t going to work out. Even if I switched it to use current standards, at least one of those gems was going to be completely gone or a million of other issues.</p>

<p>I figured that an external tool to do the same thing should be easy and I was right. I copied the 3 files related to that rake job to a new project. The code just took directories in so the only dependence on being actually <em>in</em> the Rails project was a <code>Rails.root</code> call at the beginning. I switched it to be passed in from the command line and I was done!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |  1848 |  1483 |      32 |     174 |   5 |     6 |
</span><span class='line'>| Helpers              |  2257 |  1892 |      45 |     245 |   5 |     5 |
</span><span class='line'>| Models               |  4584 |  3509 |      61 |     526 |   8 |     4 |
</span><span class='line'>| Libraries            |  2987 |  2272 |      30 |     287 |   9 |     5 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                | 11676 |  9156 |     168 |    1232 |   7 |     5 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 9156     Test LOC: 0     Code to Test Ratio: 1:0.0
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; except things were missing. The tool that comes with Rails has a certain set of directories and it only looks for code there. It included the normal Rails stuff like models and controllers but was missing anything that strayed from the prescribed structure. These pieces were missing in the default tool:</p>

<ul>
<li>Anything added to the app directory (jobs, observers)</li>
<li>Rspec tests (it only supports Test::Unit)</li>
<li>Cucumber features</li>
<li>Any code in <a href="/blog/2014/02/11/rails-4-engines/">Engines</a></li>
</ul>


<p>It turned into a bit of time sink, but was a fun project. By modifying it to use more introspection of the directory structure, I was able to cover all the pieces of the app.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>rake stats<span class="o">[</span>/path/to/app/<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Directory: /path/to/app/
</span><span class='line'>
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Name                 | Lines |   LOC | Classes | Methods | M/C | LOC/M |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Controllers          |  1848 |  1483 |      32 |     174 |   5 |     6 |
</span><span class='line'>| Helpers              |  2257 |  1892 |      45 |     245 |   5 |     5 |
</span><span class='line'>| Jobs                 |   399 |   295 |      11 |      33 |   3 |     6 |
</span><span class='line'>| Models               |  4584 |  3509 |      61 |     526 |   8 |     4 |
</span><span class='line'>| Observers            |    42 |    22 |       2 |       5 |   2 |     2 |
</span><span class='line'>| Libraries            |  2987 |  2272 |      30 |     287 |   9 |     5 |
</span><span class='line'>| Configuration        |  1233 |   669 |       4 |      17 |   4 |    37 |
</span><span class='line'>| Spec Support         |  1416 |  1152 |       4 |      30 |   7 |    36 |
</span><span class='line'>| Integration Tests    |    91 |    73 |       0 |       1 |   0 |    71 |
</span><span class='line'>| Lib Tests            |   101 |    83 |       0 |       1 |   0 |    81 |
</span><span class='line'>| Model Tests          |  3397 |  2522 |       0 |      18 |   0 |   138 |
</span><span class='line'>| Cucumber Support     |   739 |   521 |       0 |       1 |   0 |   519 |
</span><span class='line'>| Cucumber Features    |  2711 |  2487 |      29 |     145 |   5 |    15 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>| Total                | 21805 | 16980 |     218 |    1483 |   6 |     9 |
</span><span class='line'>+----------------------+-------+-------+---------+---------+-----+-------+
</span><span class='line'>  Code LOC: 10142     Test LOC: 6838     Code to Test Ratio: 1:0.7
</span></code></pre></td></tr></table></div></figure>





		
		<a href="/blog/2014/11/07/rails-stats/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-10-30T00:00:00-07:00" pubdate data-updated="true">Oct 30<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/mysql/'>mysql</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/10/30/rails-schema-with-lhm/">Rails Schema With LHM</a></h1>
	<div class="entry-content">
		<p>At <a href="https://www.taskrabbit.com">TaskRabbit</a>, we like <a href="http://www.mysql.com/">MySQL</a>. As with everything, it has its own set of issues, though. One of these issues is that it locks the table while a column is added. This is not the biggest deal in the early days of a table, but once you start getting millions of rows and consistent traffic around the clock, this prevents the site from working as expected.</p>

<p>The first way that we worked around this problem was with the <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html">pt-online-schema-change</a> tool. It does the following:</p>

<ul>
<li>Makes a a new table with the old table&#8217;s schema</li>
<li>Copies data from the old table to the new table</li>
<li>Sets up a trigger for data to keep syncing</li>
<li>Adds the column to the new table</li>
<li>Renames the old table to something else and renames the new table to replace it</li>
<li>Deletes the old table</li>
</ul>


<p>This worked quite well, but had a flaw within our process. It was outside of the development and deployment workflow. In order to develop, we would still make a <a href="http://guides.rubyonrails.org/migrations.html">Rails migration</a>. Then just before deploy, we would run the tool and add the row to the <code>schema_migrations</code> table. When we deploy, it runs migrations, but in this case it would not run because we had added that row. I don&#8217;t think we ever messed it up, but the process had a few gaps.</p>

<p>We now use <a href="https://github.com/soundcloud/lhm">LHM</a> also known as Large Hadron Migrator from the good folks at <a href="https://soundcloud.com/">soundcloud</a>. It does basically the same thing, but allows you to do it right there in the migration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;lhm&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">AddMiddleNameToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="no">Lhm</span><span class="o">.</span><span class="n">change_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class='line'>      <span class="c1"># same as: add_column :users, :middle_name</span>
</span><span class='line'>      <span class="n">m</span><span class="o">.</span><span class="n">add_column</span> <span class="ss">:middle_name</span><span class="p">,</span> <span class="s2">&quot;VARCHAR(191) DEFAULT NULL&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this is great. Now it&#8217;s in the process.</p>

<h3>Schema</h3>

<p>One design choice (and it seems like the right one) is that it makes the last step manual. That is, it leaves the old (renamed) table around. We go back and delete these from production when sure everything worked out. The above migration might leave around a table named something like this: <code>lhma_2014_10_28_20_41_56_933_users</code>.</p>

<p>So that&#8217;s fine, but you&#8217;ll notice that when you run <code>rake db:migrate</code> that your <code>schema.rb</code> file now has that table in it. This happens because ActiveRecord takes a snapshot of your database right after the migration. We try to take really good care of our schema file, so this made us sad.</p>

<p>I went poking around in the ActiveRecord code ready to monkey patch the adapter that reads the table list or the code that generates the schema file. When I got there, though, I found there was already a class setting that did what I wanted. It even took a regex!</p>

<p>So here&#8217;s what to add if you don&#8217;t want those tables showing up in your schema file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/active_record_schema.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ignore LHM</span>
</span><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">SchemaDumper</span><span class="o">.</span><span class="n">ignore_tables</span> <span class="o">&lt;&lt;</span> <span class="sr">/^lhma_/</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. Happy migrating.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-09-24T00:00:00-07:00" pubdate data-updated="true">Sep 24<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/blog/categories/geohash/'>geohash</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/09/24/geohashes/">Geohashes</a></h1>
	<div class="entry-content">
		<p>Over the years, we&#8217;ve struggled at <a href="https://www.taskrabbit.com">TaskRabbit</a> with a way to represent smaller geographic areas. Postal codes seems to be the most obvious but these vary dramatically in size. For example, there are postal codes that are just one building and ones that are bigger than some US states. We&#8217;ve also tried &#8220;neighborhood&#8221; data from various sources, but these are somewhat unreliable.</p>

<p>I recently learned about and started using <a href="http://en.wikipedia.org/wiki/Geohash">geohashes</a> to break the world into boxes and have been very happy with the results. I gave a lightning talk last week at <a href="http://gogaruco.com/">GoGaRuCo</a> on the subject. Many of them had heard about it, but the talk went over fairly well.</p>

<h3>Use Case</h3>

<p>The problem at hand is one of probabilities. Given a task, who are the best taskers for the job. Or conversely, given a tasker, what are the best few tasks for them. Taskers give us an idea of where they want to work but actions often speak louder than <s>words</s> user-drawn geographic polygons. So what I wanted to do was map their history into positive and negative areas of probability depending on what tasks they wanted to do and which they did not.</p>

<p>I had all those points and it was fairly easy to draw a heatmap using <a href="https://www.mapbox.com/mapbox.js/example/v1.0.0/leaflet-heat/">this Leaflet plugin</a>, but that needed to be mapped to something more concrete. We would be using <a href="http://www.elasticsearch.org/">Elasticsearch</a> for the storage, so while researching it&#8217;s geo functions, I stumbled across the concept of <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geohashgrid-aggregation.html">geohashes</a> which it evidently uses internally for such queries.</p>

<p><a href="http://www.bigfastblog.com/geohash-intro">This</a> article gives a really good explanation of how it works. The short version is that if you were to start with the whole world and keep cutting it in half depending on where your lat/lng was, you&#8217;d end up with a lot of left/right (or top/bottom) choices. Those choices can be encoded into binary, which can be encoded into a simple string. So this spot in London (51.507794, -0.127952) would become the &#8220;gcpvj0dyds&#8221; geohash. It has the interesting property that strings (locations) that have the same start are known to be close to it. For example, the &#8220;gcpvj09swr&#8221; geohash has the first six characters in common, so we would know that is within half a mile or so of the first one.</p>

<p>So now I have all of these points. I can map them to geohashes of the necessary precision (I chose 6) and give positive and negative weights for each user action. The actual calculation turns out to be really fast. I used the code from the <a href="https://github.com/masuidrive/pr_geohash/blob/master/lib/pr_geohash.rb">pr_geohash</a> gem and had no issues. It also calculates neighbors which turns out the be important.</p>

<p>Using the weight, I can combine and draw the geohashes (<a href="https://github.com/rgeo/rgeo">RGeo</a>/<a href="http://leafletjs.com/">Leaflet</a>). As an example, here is drawing where a particular Tasker is likely to want to work:</p>

<p><img src="/images/posts/geohashes/medium.jpg" alt="Likely to Accept" /></p>


		
		<a href="/blog/2014/09/24/geohashes/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-04-08T20:40:00-07:00" pubdate data-updated="true">Apr 8<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/chat/'>chat</a>, <a class='category' href='/blog/categories/organization/'>organization</a>, <a class='category' href='/blog/categories/sync/'>sync</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/04/08/yammer-to-hipchat/">Yammer to Hipchat</a></h1>
	<div class="entry-content">
		<p>So I&#8217;m at least two years behind blogging about various projects, but I have the list right here. I feel like being productive tonight but am not quite ready to start the next big feature so I thought I&#8217;d mention one on that list.</p>

<p>For a variety of reasons, I was trying to get everyone to migrate from <a href="https://www.yammer.com">Yammer</a> to <a href="https://www.hipchat.com">Hipchat</a> a few years back. They aren&#8217;t exactly direct competitors, but I liked the more direct Hipchat model and didn&#8217;t want to be running two distracting things all the time. The main holdout was that Yammer tended to be used for communicating to the whole company as it&#8217;s model is better suited to that.</p>

<p>I quickly made <a href="https://github.com/bleonard/yam2hip">yam2hip</a> to sync them over to my new client of choice. It&#8217;s made to deploy to <a href="https://www.heroku.com/">Heroku</a>. Every 90 seconds it will look for new Yammer messages and post them in a Hipchat room. I made a Hipchat room called &#8220;Yammer&#8221; to be the target room.</p>

<p>If people would have continued to use both, I probably would have made it bi-directional; however, we are now quite happily all on Hipchat (boom).</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-04-05T16:54:00-07:00" pubdate data-updated="true">Apr 5<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/iphone/'>iphone</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/04/05/ios-auth-blocks/">iOS Authentication Blocks</a></h1>
	<div class="entry-content">
		<p>In my recent project, <a href="http://www.bleonard.com/blog/2014/04/03/cakewalk/">Cakewalk</a>, we give the user a fairly complete experience without having to sign up. This seems like the nice thing to do but it&#8217;s also in Apple&#8217;s guidelines for app approval. At some point, though, we need to create an account for them. In our case, it&#8217;s when they want to add an idea to their favorites or save their filter preferences. A &#8220;gate&#8221; such as this is something I&#8217;ve done on the web many times but it&#8217;s the first time I&#8217;ve done it an iPhone app. I&#8217;ll describe how I solved it using <a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/Blocks/Articles/bxGettingStarted.html#//apple_ref/doc/uid/TP40007502-CH7-SW1">blocks</a>.</p>

<h2>Web</h2>

<p>On the web, I would usually send them to a URL. If that URL requires a logged in user, then it would redirect to the login/signup URL with a query param. For example, if the page was <code>http://www.example.com/favorite</code>, it would redirect to something like <code>http://www.example.com/login?after_auth=%2Ffavorite</code>. The login/signup form would add this as a hidden parameter that it POSTs. If the action is successful, it will use this url instead of the default one to send the user to next place. In Rails, it would look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">login</span>
</span><span class='line'>  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># right!</span>
</span><span class='line'>    <span class="n">log_in!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">params</span><span class="o">[</span><span class="ss">:after_auth</span><span class="o">]</span> <span class="o">||</span> <span class="n">dashboard_path</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="c1"># not right!</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:form</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the site allows the users to switch back and forth between login and signup pages or allows Facebook, Twitter or some other OAuth, it can be easy to lose this parameter. I&#8217;ve seen sites put the value in a cookie for this reason. It can simplify it, but is more likely to have unintended site effects.</p>

<h2>Blocks</h2>

<p>Most of the complexity of the web version is because of the stateless nature of the medium. The query parameter or cookie is an attempt to add that state globally. This is not particularly an issue in an iPhone app. The global state is fairly well known in the view controllers and there is shared memory. The interesting thing that I realized is that it&#8217;s not just data that we can store, but also <a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/Blocks/Articles/bxGettingStarted.html#//apple_ref/doc/uid/TP40007502-CH7-SW1">blocks</a>.</p>

<p>An Objective C block is an inline declaration of a function. It is similar to features available in Ruby and Javascript. Here we use one to change how a sort is done:</p>


		
		<a href="/blog/2014/04/05/ios-auth-blocks/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-04-03T21:10:00-07:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/caching/'>caching</a>, <a class='category' href='/blog/categories/iphone/'>iphone</a>, <a class='category' href='/blog/categories/kids/'>kids</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/04/03/cakewalk/">Cakewalk</a></h1>
	<div class="entry-content">
		<p>It&#8217;s nice to be useful. I was glad to be able to help out my wife and her partner make a new iPhone app called <a href="http://www.cakewalkapp.com">Cakewalk</a>.</p>

<p>I really like the counter-culture situation of it. Technology has become a way to distract the kids or something you can hand them when you are out of other things to do. <a href="http://www.personify.us">Krista</a> and <a href="http://www.textunvexed.com">Marijane</a> had the idea to use technology to go the other way by giving parents an app that was for them, not the kids. And the goal of the app is to stop using the app and start real playtime with the kids.</p>

<p>Put simply, Cakewalk comes in handy when the kids really want to play with you, but you’re having a hard time coming up with something to do. It is full of quick ideas for simple fun. And every activity is something you can do right now—no research, no prep, and no trips to the store.</p>

<p>So get it now on the App Store <a href="http://www.cakewalkapp.com/get">here</a>. See below for the tech notes on how it was built.</p>

<p><img src="/images/posts/cakewalk/HoolaPhoto.jpg" alt="Cakewalk Idea" /></p>


		
		<a href="/blog/2014/04/03/cakewalk/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-03-16T10:31:00-07:00" pubdate data-updated="true">Mar 16<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/tests/'>tests</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/03/16/offshore/">Offshore: Rails Remote Factories</a></h1>
	<div class="entry-content">
		<p>Last year at <a href="https://www.taskrabbit.com">TaskRabbit</a>, we decided to go headlong into this <a href="http://en.wikipedia.org/wiki/Service-oriented_architecture">Service Oriented Architecture</a> thing. We ended up with several <a href="http://rubyonrails.org/">Rails</a> and <a href="http://www.sinatrarb.com/">other</a> Ruby apps that loosely depended on each other to work. While this was mostly good from a separation of concerns and organizational perspective, we found effective automated testing to be quite difficult.</p>

<p>Specifically, we have one core platform application whose API is the most used. We also allow other apps to have read-only access to its database. Several of the apps are more or less a client to that server. So while the satellite apps have their own test suite, the integration tests can only be correct if they are exercising the core API.</p>

<p>To handle this use case, we created a gem called <a href="https://github.com/taskrabbit/offshore">Offshore</a>. A normal test suite has <a href="https://github.com/thoughtbot/factory_girl">factories</a> and/or <a href="http://guides.rubyonrails.org/testing.html#the-low-down-on-fixtures">fixture data</a> and it uses database <a href="http://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html">transactions</a> to reset the data for every test. Offshore brings this the SOA world by providing the ability to use another application&#8217;s factories from your test suite as well as handling the rollback between tests. Through the actual exercising of the other application as well as a simplified usage pattern, we found that we trusted our integration tests much more that alternative approaches.</p>

<h2>System</h2>

<p>What we have are several apps based on use case, all using a core platform. There are web apps for each of the participants in our marketplace: workers, consumers, and businesses. We also have iPhone and Android apps along those same lines.</p>

<p>The apps communicate in a few ways. All of them use the platform&#8217;s API synchronously. The web apps use <a href="https://github.com/taskrabbit/resque-bus">Resque Bus</a> to subscribe and publish asynchronously. We also allow the web apps to read the platform database, but not write.</p>

<p><img src="/images/posts/offshore/generic_network_map.png" alt="Network Map" /></p>

<h2>Use Case</h2>

<p>The APIs and data involved are basically about tasks and users in the system and their various state transitions. For example, our business app signs up a user and post a tasks using the API. The user will then be on the their dashboard seeing a list of tasks in various states, conversations with the workers, payment details, etc.</p>


		
		<a href="/blog/2014/03/16/offshore/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-03-06T15:57:00-08:00" pubdate data-updated="true">Mar 6<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/blog/'>blog</a>, <a class='category' href='/blog/categories/jekyll/'>jekyll</a>, <a class='category' href='/blog/categories/octopress/'>octopress</a>, <a class='category' href='/blog/categories/plugins/'>plugins</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/03/06/jekyll-slides/">Jekyll Slides</a></h1>
	<div class="entry-content">
		<p>I really like <a href="http://jekyllrb.com/">Jekyll</a>/<a href="http://octopress.org/">Octopress</a> and have aspirations to make my presentations in HTML instead of Powerpoint. For my last <a href="http://www.meetup.com/San-Francisco-Redis-Meetup/events/164972192/">presentation to the Redis Meetup</a>, I combined the two. I found it really easy to &#8220;blog&#8221; the talk and created a <a href="https://github.com/bleonard/jekyll-slides">plugin</a> to convert <a href="http://www.bleonard.com/blog/2014/02/16/resque-bus-presentation/">that</a> to a <a href="http://lab.hakim.se/reveal-js">reveal.js</a> <a href="http://www.bleonard.com/blog/2014/02/16/resque-bus-presentation/slides">presentation</a> from the same source. It&#8217;s my first Jekyll plugin, but it got the job done. Check it out <a href="https://github.com/bleonard/jekyll-slides">here</a>.</p>

<h2>Usage</h2>

<p>Make a new blog post and add <code>slides: simple</code> to the metadata at the top. The value <code>simple</code> refers to the <a href="http://lab.hakim.se/reveal-js/?theme=solarized#/themes">reveal.js theme</a> to use. The options are: <code>beige</code>, <code>blood</code>, <code>moon</code>, <code>night</code>, <code>serif</code>, <code>simple</code>, <code>sky</code>, and <code>solarized</code>.</p>

<p>Here is the header from the <a href="http://www.bleonard.com/blog/2014/02/16/resque-bus-presentation/slides">last presentation</a>:</p>

<pre><code>---
layout: post
published: true
title: "Resque Bus Presentation"
date: 2014-02-16 08:48
comments: true
author: BL
slides: simple
categories: architecture resque redis bus
---
</code></pre>

<p>You then write your normal blog post with a few extra elements mixed in.</p>

<p>For example, you start a slide with the <code>{% slide %}</code> notation. You can also say <code>{% notes %}</code> at the &#8220;bottom&#8221; of a slide. This will not appear in the slideshow, but will appear in the blog post.</p>

<p>You say <code>{% endslide %}</code> at the end of the presentation. You could do this each time, but it&#8217;s inferred by the beginning of a new slide using <code>{% slide %}</code>, so the end notation is only needed at the end.</p>

<p>That&#8217;s about it. Here &#8216;s the whole presentation if it was only a few of the slides:</p>

<pre><code>{% slide %}

## Resque Bus

### Brian Leonard

##### TaskRabbit
##### 02/17/2014

{% notes %}

Hi, my name is Brian Leonard and I'm the Chief Architect and Technical Cofounder of TaskRabbit. TaskRabbit is a marketplace where neighbors help neighbors get things done.

At TaskRabbit we are using Redis and Resque to do all of our background processing. We've also gone one step further to use these tools to create an asynchronous message bus system that we call Resque Bus.

{% slide %}

### Redis

* Key/Value Store
* Atomic Operations

![Redis Logo](/images/posts/resque-bus-presentation/redis-logo.jpeg)

{% notes %}

I don't have to tell you guys about Redis, but for our purposes the main point is that we can store stuff in it and the operations are atomic.

{% slide %}

## Thanks!

Questions?

{% endslide %}
</code></pre>

<p>Compilation produces the <a href="http://www.bleonard.com/blog/2014/02/16/resque-bus-presentation/">blog post here</a> as well as the <a href="http://www.bleonard.com/blog/2014/02/16/resque-bus-presentation/slides">presentation here</a>.</p>


		
		<a href="/blog/2014/03/06/jekyll-slides/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-02-16T08:48:00-08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/bus/'>bus</a>, <a class='category' href='/blog/categories/redis/'>redis</a>, <a class='category' href='/blog/categories/resque/'>resque</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2014/02/16/resque-bus-presentation/">Resque Bus Presentation</a></h1>
	<div class="entry-content">
		<p><a href="/blog/2014/02/16/resque-bus-presentation/slides"><h2>View the Presentation</h2></a></p>

<h5>Or view the slide sheet below</h5>


<hr />


<section class='slide'><div class='content'>

<h2>Resque Bus</h2>

<h3>Brian Leonard</h3>

<h5>TaskRabbit</h5>

<h5>02/17/2014</h5>


		
		<a href="/blog/2014/02/16/resque-bus-presentation/" class="more-link">Read on &rarr;</a>
	</div>

</article>

<nav id="pagenavi">
    
        <a href="/blog/page/2/" class="prev">Prev</a>
    
    
        <a href="/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Brian Leonard

</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'bleonard';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



		</div>
	</div>
</body>
</html>
