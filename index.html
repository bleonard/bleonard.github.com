
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>BLog</title>
	<meta name="author" content="Brian Leonard">

	
	<meta name="description" content="The last post in our architecture series discussed background processing. There is a special type of background processing that I wanted to make a &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="BLog" type="application/atom+xml">
	
	<link rel="canonical" href="http://bleonard.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/assets/slides/css/for_blog.css">
	
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>

<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<a href="/"><img src="/images/dp.jpg" alt="Profile Picture" style="width: 160px;"></a>
</div>
<h1><a href="/">BLog</a></h1>
<p class="subtitle">Strong catchphrase situation here</p>
<p class="description">Chief Architect and Technical Co-founder of TaskRabbit - neighbors helping neighbors through technology.</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
	  
	  <a class="taskrabbit" href="http://www.taskrabbit.com" title="TaskRabbit">TaskRabbit</a>
	  
		
		
		
		<a class="github" href="https://github.com/bleonard" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/BrianL429">LinkedIn</a>
		
		
		<a class="twitter" href="http://twitter.com/bleonard" title="Twitter">Twitter</a>
		
		
		
		
		<a class="rss" href="/atom.xml" title="Feed">Feed</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-04-14T00:00:00-07:00" pubdate data-updated="true">Apr 14<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/resque/'>resque</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2017/04/14/architecture-consider-kron/">Architecture: Consider Kron</a></h1>
	<div class="entry-content">
		<p>The last post in our architecture series discussed <a href="/blog/2017/03/17/architecture-background-processing/">background processing</a>. There is a special type of background processing that I wanted to make a quick note about. These are things that need to be done periodically or otherwise on a schedule.</p>

<p>In our internal speak, we call this a &#8220;kron&#8221; job. If you are familiar with <a href="https://en.wikipedia.org/wiki/Cron">cron</a> jobs, it&#8217;s the same idea. A product manager misspelled it once and it stuck! We don&#8217;t actually use regular cron infrastructure, so the spelling <em>nuance</em> is helpful.</p>

<p>The specifics of how we implement it involve our <a href="/blog/2015/04/02/queue-bus/">message bus</a> infrastructure, but I think the concept and the decisions involved could include many other implementations.</p>

<h3>When to use it</h3>

<p>Let&#8217;s take the job from the <a href="/blog/2017/03/17/architecture-background-processing/">previous article</a>. The &#8220;charge an invoice 24 hours later&#8221; case is an interesting one. The system certainly supports delaying that code to run for an arbitrary time, but that&#8217;s not always the best idea.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceChargeWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">worker_lock</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">unless</span> <span class="n">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">charge!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_id</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">to_id</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">pending?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">invoice</span>
</span><span class='line'>    <span class="vi">@invoice</span> <span class="o">||=</span> <span class="no">Invoice</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># When invoice is created</span>
</span><span class='line'><span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">enqueue_at</span><span class="p">(</span><span class="mi">24</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">from_now</span><span class="p">,</span> <span class="n">invoice_id</span><span class="p">:</span> <span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>One reason would be memory. When there a lot of invoices (woot!), we still have to save the notion of what should be done somewhere until it gets processed. In this case, the <a href="https://redis.io/">Redis</a> instance will have it stored in memory. The memory could fill up and adding more workers won&#8217;t help because of the delay.</p>

<p>The second reason is stability. This is important stuff and Redis could have issues and lose the data. We made everything <a href="http://www.restapitutorial.com/lessons/idempotency.html">idempotent</a> and could recreate everything, but it would certainly be a huge hassle.</p>

<p>So when enqueueing something to run in the future, especially if it is important or a long time from now (more than a few minutes), we consider kron.</p>

<h3>Batch mode</h3>

<p>If we were going to accomplish the same things but on a schedule, the code would have to change in some way. I like the existing worker because it already has the good stuff from the last article: source of truth, knowing whether or not it still needs to be run, and mutual exclusion. When batch processing, I believe it&#8217;s also good to still operate on this one at a time where the count (memory for redis) is low or the risk of issues is high. Both are the case here.</p>

<p>To turn it into a batch processor we need to know what needs to be processed at any given moment. This is easy to determine because we have the <code>needed?</code> method. It looks to be invoices that are in the <code>pending</code> state. Sometimes we need to add a <code>state</code> column or other piece of data to know what needs to be in the batch but in this case we are good to go.</p>

<p>From there we can decide if we are going to update the class as-is or make a batch worker. A batch worker is its own worker and would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceChargeBatchWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">worker_lock</span> <span class="ss">:all</span>
</span><span class='line'>  <span class="n">queue_lock</span>  <span class="ss">:all</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="no">Invoice</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stat</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
</span><span class='line'>      <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">:</span> <span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># process all pending invoices</span>
</span><span class='line'><span class="no">InvoiceChargeBatchWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. Because of the worker lock on <code>InvoiceChargeWorker</code> and the state checking, it would be ok even if we were to enqueue it twice or something. Making a custom batch worker also prevents us from running this code twice.</p>

<p>We could also stick it as a class method on the original:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceChargeWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">worker_lock</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">process_all!</span>
</span><span class='line'>    <span class="no">Invoice</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stat</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invoice</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">:</span> <span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">unless</span> <span class="n">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">charge!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">pending?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">invoice</span>
</span><span class='line'>    <span class="vi">@invoice</span> <span class="o">||=</span> <span class="no">Invoice</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># process all pending invoices</span>
</span><span class='line'><span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span></code></pre></td></tr></table></div></figure>


<h3>How it works</h3>

<p>Again, in any given architecture there is probably a best way to do it. For example, maybe <a href="https://medium.com/airbnb-engineering/chronos-a-replacement-for-cron-f05d7d986a9d">this</a> is a good way to do it on top of <a href="http://mesos.apache.org/">Mesos</a>.</p>

<p>The challenge is running something on a schedule. In this case, process all invoices that need to be paid. That is what regular cron is made to do. However, we do not want to run that on every box. If we did that, we would have serious race conditions and might pay an invoice twice. Rather, we want to run it once globally across the entire infrastructure or at least per service.</p>

<p>We could probably do this by noting in the devops setup that one of the servers is special. It should get the cron setup. We could use something like the <a href="https://github.com/javan/whenever">whenever gem</a> to say what to do and we would only run that on one box per system. It needs to be per system because it has to be able to know what worker to enqueue or, in general, what code to run.</p>

<p>What we do instead is have a single service that has a process that sends out a heartbeat on the <a href="/blog/2015/04/02/queue-bus/">message bus</a>. Every minute, it publishes an event that looks like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># for Tue, 11 Apr 2017 00:25:00 UTC +00:00</span>
</span><span class='line'>  <span class="c1"># epoch time: 1491870300</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">QueueBus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">heartbeat_seconds</span><span class="s2">&quot;, {</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">epoch_seconds</span><span class="s2">&quot;=&gt;1491870300,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">epoch_minutes</span><span class="s2">&quot;=&gt;24864505,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">epoch_hours</span><span class="s2">&quot;=&gt;414408,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">epoch_days</span><span class="s2">&quot;=&gt;17267,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">minute</span><span class="s2">&quot;=&gt;25,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">hour</span><span class="s2">&quot;=&gt;0, </span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">day</span><span class="s2">&quot;=&gt;11,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">month</span><span class="s2">&quot;=&gt;4,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">year</span><span class="s2">&quot;=&gt;2017,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">yday</span><span class="s2">&quot;=&gt;101,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="n">wday</span><span class="s2">&quot;=&gt;2</span>
</span><span class='line'><span class="s2">  })</span>
</span></code></pre></td></tr></table></div></figure>


<p>The current code for the process is already checked into <a href="https://github.com/queue-bus/queue-bus">queue-bus</a> and ready to use <a href="https://github.com/queue-bus/queue-bus/blob/5c009a3b2d2d58994813bdca0dc78547a18b0295/lib/queue_bus/heartbeat.rb">here</a>.</p>

<p><a href="https://github.com/queue-bus/resque-bus">Resque bus</a> supports this using the <a href="https://github.com/resque/resque-scheduler">resque-scheduler gem</a>. It is setup off by calling <code>QueueBus.heartbeat!</code>. We make sure it&#8217;s setup every time we start up Resque.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:resque</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:setup</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:environment</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque_scheduler&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque/scheduler&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;tresque&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">QueueBus</span><span class="o">.</span><span class="n">heartbeat!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This <code>setup</code> is automatically called every time Resque starts.</p>

<h3>Usage</h3>

<p>So now we can subscribe to this event to run something every minute, hour, day, Monday, month, whatever.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># every minute</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;every_minute&quot;</span><span class="p">,</span> <span class="s1">&#39;bus_event_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;heartbeat_minutes&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># every hour: 4:22, 5:22, 6:22, etc</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;once_an_hour&quot;</span><span class="p">,</span> <span class="s1">&#39;bus_event_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;heartbeat_minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">22</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># every day at 12:05 am</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;once_a_day&quot;</span><span class="p">,</span> <span class="s1">&#39;bus_event_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;heartbeat_minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># every monday at 1:52 am</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;early_monday_morning&quot;</span><span class="p">,</span> <span class="s1">&#39;bus_event_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;heartbeat_minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;wday&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">52</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># the 3rd of every month at 2:10 am</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;once_a_month&quot;</span><span class="p">,</span> <span class="s1">&#39;bus_event_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;heartbeat_minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># every 5 minutes: 4:00, 4:05, 4:10, etc</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;every 5 minutes&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># if it doesn&#39;t fit the subscribe pattern, just subscribe to every minute and use ruby</span>
</span><span class='line'>  <span class="k">next</span> <span class="k">unless</span> <span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;minute&#39;</span><span class="o">]</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>  <span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">process_all!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Summary</h3>

<p>So that is how &#8220;kron&#8221; works.</p>

<p>Over time, we have decided this is a much more reliable way to process items in the background when a delay is acceptable. By setting up some sort of centralized architecture for this, many services and subscribe in a way that is familiar and unsurprising. We have found a lot of value in that.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-03-17T00:00:00-07:00" pubdate data-updated="true">Mar 17<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/resque/'>resque</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2017/03/17/architecture-background-processing/">Architecture: Background Processing</a></h1>
	<div class="entry-content">
		<p>So we have a bunch of <a href="/blog/2017/02/24/architecture-models/">models</a> and are doing stuff with them in <a href="/blog/2017/03/03/architecture-service-objects/">service objects</a>. The next thing we might need is to process some code in the background.</p>

<p>Not everything can be done inline from the API request. For example, we might need to geocode a user&#8217;s postal code when they change it in their account. Or when an invoice is created, we want to charge it 24 hours later.</p>

<p>When working with background jobs, we default to the following practices:</p>

<ul>
<li>Workers are enqueued with a dictionary of inputs</li>
<li>These inputs should be used to fetch data from the source of truth</li>
<li>Workers know how to check if they still need to run</li>
<li>Locking schemes should protect parallel execution</li>
</ul>


<h3>Enqueue</h3>

<p>When we enqueue a worker, we have found that it&#8217;s quite helpful to always use a dictionary (hash) of key/value pairs. <a href="https://github.com/resque/resque">Resque</a> and <a href="http://sidekiq.org/">Sidekiq</a> both take a list of arguments like <a href="https://github.com/mperham/sidekiq/wiki/Getting-Started">so</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HardWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># do something with name, count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># enqueue</span>
</span><span class='line'><span class="no">HardWorker</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has proved to be problematic when adding new parameters or having optional parameters. For example, if we add a new (third) input parameter, there might be stuff in the queue with the old two. When the new code gets deployed, it will throw an &#8216;invalid number of arguments&#8217; type of error. When using a hash, we can give it a default, fail gracefully, or do whatever we like on a class by class basis.</p>

<p>So to provide better change management and optional arguments, we always do it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HardWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="c1"># do something with self.name, self.count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># enqueue</span>
</span><span class='line'><span class="no">HardWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Source of Truth</h3>

<p>Let&#8217;s say we want to update a search index every time a user record is changed. We need to write their first name, last name, etc to <a href="https://www.elastic.co/">Elasticsearch</a>.</p>

<p>We could do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserIndexWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:etc</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="no">Elasticsearch</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="n">first_name</span><span class="p">:</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">:</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">etc</span><span class="p">:</span> <span class="n">etc</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># When user changes</span>
</span><span class='line'><span class="no">UserIndexWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:etc</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This certainly would work, but is not considered best practice. It is better to be <a href="http://www.restapitutorial.com/lessons/idempotency.html">idempotent</a>. It writes everything that should ) by passing the minimal information to the background worker, who then looks up the source of truth. That way, if there is any delay between when it is enqueued and run, it will still send the correct information.</p>

<p>The better approach would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserIndexWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:user_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="no">Elasticsearch</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:etc</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># When user changes</span>
</span><span class='line'><span class="no">UserIndexWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the same vein, the worker should be in charge of whether or not it needs to do anything in the first place. For example, we can enqueue a worker to run later about an <code>Invoice</code>. If, at that time, the payment is <code>Invoice</code> still should be charged, then charge it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceChargeWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">unless</span> <span class="n">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">charge!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">pending?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">invoice</span>
</span><span class='line'>    <span class="vi">@invoice</span> <span class="o">||=</span> <span class="no">Invoice</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># When invoice is created</span>
</span><span class='line'><span class="no">InvoiceChargeWorker</span><span class="o">.</span><span class="n">enqueue_at</span><span class="p">(</span><span class="mi">24</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">from_now</span><span class="p">,</span> <span class="n">invoice_id</span><span class="p">:</span> <span class="n">invoice</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is another example of single source of truth. Even for jobs that are run immediately, this check is something we always put in place: return immediately if the worker is no longer relevant.</p>

<h3>Mutual Exclusion</h3>

<p>Let&#8217;s say the <code>User</code> object can sometimes change a few times rapidly. The &#8220;source of truth&#8221; approach will make sure the right thing always gets indexed. So that&#8217;s great. But it is pretty silly to index the same data twice or more times, right?</p>

<p>In this case, we add a queue lock. The effect is that if something is in the queue and waiting to be processed and you try to enqueue another one with the same inputs, then it will be a no-op. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserIndexWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:user_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue_lock</span> <span class="ss">:user_id</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another case that often arises is mutual exclusion for <em>runtime</em>. Maybe weird payment things happen to the payment service if two invoices for the same user are happening at the same time.</p>

<p>In this case, we add a worker lock. The effect is that if something is in the queue and about to start running and there is another running at that moment, then it will re-enqueue itself to run later. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceChargeWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>  <span class="n">inputs</span> <span class="ss">:invoice_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">worker_lock</span> <span class="ss">:to_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">work</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">unless</span> <span class="n">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">charge!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_id</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">to_id</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">needed?</span>
</span><span class='line'>    <span class="n">invoice</span><span class="o">.</span><span class="n">pending?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">invoice</span>
</span><span class='line'>    <span class="vi">@invoice</span> <span class="o">||=</span> <span class="no">Invoice</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invoice_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>For either type, you don&#8217;t have to lock on all the attributes or can (as shown in the last example) use calculations. The namespace of the lock is the worker class name. You can also set the namespace to allow locking between different workers.</p>

<h3>Message Bus</h3>

<p>Our <a href="/blog/2015/04/02/queue-bus/">message bus</a> and our use of background processes have a lot in common. In fact, the message bus is built on top of the same background processing infrastructure. The question that arises is this: when should something be enqueued directly and when should it publish and respond to a bus subscription?</p>

<p>The first note is that you should <em>always be publishing</em> (ABP). It doesn&#8217;t hurt anything to give (optional) visibility to other systems what is happening. Or use this as logging framework.</p>

<p>Just publishing, however, doesn&#8217;t mean we have to use that to do work in the background. Be can bother publish and enqueue a background worker. We enqueue a worker when the work in the background is essential to the correct operation of the use case at hand.</p>

<p>One example to enqueue directly would be the geocoding worker I mentioned earlier: when the user gives a new postal code, figure out where that is. It&#8217;s key to the account management system.</p>

<p>The search example I&#8217;ve been using might not actually be the best one because we would have the search system subscribed to changes in the account system. What I didn&#8217;t show that the <code>enqueue</code> call might actually happen from within a subscription.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">subscribe</span> <span class="s2">&quot;user_changed&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="no">UserIndexWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So these two concepts can work together. Why not just index it right in the subscription, though? A primary reason might be to use some of the locking mechanisms as the bus does not have that. It also might be the case that the worker is enqueued from other locations and this keeps things DRY. The worker is also easier to unit test.</p>

<h3>TResque</h3>

<p>We use <a href="https://github.com/resque/resque">Resque</a> as a base foundation and built on top of it with an abstraction layer called <a href="https://github.com/taskrabbit/tresque">TResque</a>. That&#8217;s TR (TaskRabbit) Resque. Get it? It puts all of these practices into place as well as adding and abstraction layer for the inevitable, but as yet unprioritized, move to <a href="http://sidekiq.org/">Sidekiq</a>.</p>

<p>I don&#8217;t necessarily expect anyone to use this, but it doesn&#8217;t hurt to make it available as an example of how we are using these tools.</p>

<p>You define a worker and enqueue things as show in the examples above. Then only layer left is around prioritization. You can give a queue name to a worker and then register what priority those workers are. If no queue is given, it is assumed to be the <code>default</code> queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;tresque&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Account</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">RegularWorker</span>
</span><span class='line'>    <span class="kp">include</span> <span class="o">::</span><span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>    <span class="c1"># defaults to account_default queue</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Account</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">RegularWorker</span>
</span><span class='line'>    <span class="kp">include</span> <span class="o">::</span><span class="no">TResque</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>    <span class="n">queue</span> <span class="ss">:refresh</span> <span class="c1"># lower priority account_refresh queue</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">TResque</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;account&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue</span> <span class="ss">:default</span><span class="p">,</span> <span class="mi">100</span>
</span><span class='line'>  <span class="n">queue</span> <span class="ss">:refresh</span><span class="p">,</span> <span class="o">-</span><span class="mi">5000</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then when you run Resque, you can use these registrations to process the queues in the right order.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;resque/tasks&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;resque_scheduler/tasks&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;resque_bus/tasks&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:resque</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:setup</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:environment</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque_scheduler&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;resque/scheduler&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;tresque&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:queues</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:setup</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">queues</span> <span class="o">=</span> <span class="o">::</span><span class="no">TResque</span><span class="o">::</span><span class="no">Registry</span><span class="o">.</span><span class="n">queues</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;QUEUES&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;TResque: </span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;QUEUES&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="err">$</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="n">resque</span><span class="ss">:queues</span> <span class="n">resque</span><span class="ss">:work</span>
</span><span class='line'>  <span class="no">TResque</span><span class="p">:</span> <span class="n">account_default</span><span class="p">,</span> <span class="n">account_refresh</span>
</span></code></pre></td></tr></table></div></figure>


<p>This registration layer allows each of the systems (<a href="/blog/2014/02/11/rails-4-engines/">engines</a>) to work independently and still have centralized background processing.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-03-10T00:00:00-08:00" pubdate data-updated="true">Mar 10<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/bus/'>bus</a>, <a class='category' href='/blog/categories/engines/'>engines</a>, <a class='category' href='/blog/categories/queue/'>queue</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2017/03/10/architecture-surface-area/">Architecture: Surface Area</a></h1>
	<div class="entry-content">
		<p>The last post in the <a href="https://www.taskrabbit.com">TaskRabbit</a> architecture series was about <a href="/blog/2017/03/03/architecture-service-objects/">service objects</a>. This an example of what I call minimizing &#8220;surface area&#8221; of the code.</p>

<p>Frankly, I might be using the term wrong. It seems possible &#8220;surface area&#8221; usually refers to API signature of some objects. What I&#8217;m talking about here is the following train of thought:</p>

<ul>
<li>I change or add a line of code</li>
<li>What did I just affect?</li>
</ul>


<p>The &#8220;surface area&#8221; is the other things I have to look over. It is the area that I have to make sure has appropriate test coverage. Having a large surface area is what slows down development teams. The goal is to minimize it.</p>

<h3>Service Objects</h3>

<p>So how does our use of service objects relate to this concept?</p>

<p>Let&#8217;s say we have a new requirement that&#8217;s applicable when a Tasker submits an invoice that modifies what gets saved. If I were to add the code to the <code>InvoiceJobOp</code> from the <a href="/blog/2017/03/03/architecture-service-objects/">previous article</a>, then it will only apply when the <code>Op</code> is run. If we were to do something in a <code>before_save</code> in the <code>Invoice</code> model, then it might accidentally kick in anytime an <code>Invoice</code> is changed.</p>

<p>That&#8217;s a lot more tests and things to keep in our mind. If it is just in the <code>Op</code>, that is less of those kinds of debt, so adding in the <code>Op</code> is an example of minimizing the surface area of the change.</p>

<h3>Namespacing</h3>

<p>We went through a <a href="/blog/2015/10/06/v2-retrospective/">roundabout journey</a> to end up where were we are. Many of the changes were about surface area and trying to reduce it.</p>

<p>People like microservices and SOA because of this same principle. We tried it and that part of it worked out really well. There was just no way that a change in service A could affect service B. As <a href="/blog/2015/10/06/v2-retrospective/">discussed</a>, however, we ran into issues in other dimensions.</p>

<p>Our current use of <a href="/blog/2014/02/11/rails-4-engines/">engines</a> follows the same approach to achieve the same surface area effect. It is all about namespacing. Modifying the user management engine can not affect the marketplace engine. This allows us to proceed with more confidence when making such changes.</p>

<p>A particular aspect of our setup is that any given model is &#8220;owned&#8221; by only one engine. The rest of the engines are allowed to read from the database but they cannot write. This provides sanity and minimizes the surface area. For example, the validations only need to live in one spot. You also know that no other code can go rogue and start messing with the data by accident or otherwise.</p>

<h3>Bus</h3>

<p>Of course, the world isn&#8217;t always cut and dry. Venn diagrams overlap. No abstraction or encapsulation is perfect. The seams in namespacing show up when something that happens in one service (engine) needs to affect something in another one.</p>

<p>For example, we were so happy just a few paragraphs ago that changes to the user management engine do not affect the marketplace engine. That is true and it is great. There is no direct effect from the code. However, as they tend to do, these pesky functional requirements always mess up perfect plans for the code. In this case, when a user changes their first name (in the account engine), the marketplace engine might need to update some data in <a href="https://www.elastic.co/">Elasticsearch</a>.</p>

<p>We use a <a href="/blog/2015/04/02/queue-bus/">message bus</a> to observe changes like this and react as appropriate.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Whenever the user changes</span>
</span><span class='line'><span class="n">subscribe</span> <span class="s1">&#39;user_may_have_changed&#39;</span><span class="p">,</span> <span class="n">bus_observer_touched</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">attributes</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># update the profile in ElasticSearch</span>
</span><span class='line'>  <span class="no">ProfileStoreWorker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>An important note here is that <code>ProfileStoreWorker</code> is <a href="http://www.restapitutorial.com/lessons/idempotency.html">idempotent</a>. It writes everything that should go in Elasticsearch every time. This technique reduces surface area by not depending on this single event and its contents, but rather only as a trigger.</p>

<p>One might say that these subscriptions are just as coupled as doing everything all in one spot. I see that point because, of course, the same things end up happening. However, we have this technique to be better for a few reasons.</p>

<ul>
<li>The trigger code (in the account engine) does not need to know about the rest of the system. It can mind its own business.</li>
<li>The subscribing code (in the marketplace engine) can be self-contained instead of being mixed up in the trigger code path.</li>
<li>Many different code paths might necessitate the <code>ProfileStoreWorker</code> to run. By decoupling it, we actually save complexity in many code paths.</li>
</ul>


<h3>Summary</h3>

<p>In code, developers tend to weave a tangled web wherein seemingly innocuous changes have far-reaching effects. We have been able to create more stable and agile code by considering the &#8220;surface area&#8221; of a change and minimizing it through some encapsulation and decoupling techniques.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-03-03T00:00:00-08:00" pubdate data-updated="true">Mar 3<span>rd</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2017/03/03/architecture-service-objects/">Architecture: Service Objects</a></h1>
	<div class="entry-content">
		<p>This is the second post in what is now indisputably a &#8220;series&#8221; of articles about how we build things at <a href="https://www.taskrabbit.com">TaskRabbit</a>. Over time, we/I have internalized all kinds of lessons and patterns and are trying to take the time to write some of the key things down.</p>

<p>Building upwards from the <a href="/blog/2017/02/24/architecture-models/">last article about models</a>, let&#8217;s talk about how we use them. The models represent rows in the database in the <a href="http://guides.rubyonrails.org/active_record_basics.html">Rails ORM</a>. What code is deciding what to put in those rows and which ones should be created, etc? In our architecture, this role is filled by <a href="https://www.netguru.co/blog/service-objects-in-rails-will-help">service objects</a>.</p>

<p>Overall, we default to the following rules when using models in our system:</p>

<ul>
<li>Models contain data/state validations and methods tied directly to them</li>
<li>Models are manipulated by service objects that reflect the user experience</li>
</ul>


<h3>Something has to be fat</h3>

<p>In the beginning, there was <a href="http://ideum.com/2006/07/05/102/">Rails</a> and we saw that it was good. The world was optimized around the CRUD/REST use cases. Controllers had <code>update_attributes</code> and such. When there was more logic/nuance, it was put there in the controller (or the view).</p>

<p>There was a backlash of sorts against that and the new paradigm was <a href="http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model">&#8220;Fat model, skinny controller&#8221;</a>. The controllers were simple and emphasized workflow instead of business logic. Views were simpler. That stuff was put in the models. Model code was easier to reuse.</p>

<p>Thus arose the great <a href="http://blog.codeclimate.com/blog/2012/10/17/7-ways-to-decompose-fat-activerecord-models/">&#8220;God Model&#8221;</a> issue. Fat is one thing, but we had some seriously obese models. Things like <code>User</code> and <code>Task</code> simply had too much going on. We could put stuff in mixins/concerns but that didn&#8217;t change the fact that there was tons of code that all could be subtly interacting with each other.</p>

<p>Business logic has to go somewhere. For us, that somewhere is in service objects.</p>

<h3>Operations</h3>

<p>In our architecture, we call them &#8220;Operations&#8221; and they extend a class called <code>Backend::Op</code>. This more or less uses the <a href="https://github.com/mnelson/subroutine">subroutine</a> gem.</p>

<p>Much can be read about what it means to be a service object, but here is my very scientific (Rails-specific) definition.</p>

<ul>
<li>Includes <code>ActiveModel</code> stuff like <code>Naming</code>, <code>Validations</code>, and <code>Callbacks</code></li>
<li>Allows declaration of what fields (input parameters) it uses</li>
<li>Reflects an action in the system like &#8220;sign up a user&#8221; or &#8220;invoice a job&#8221;</li>
<li>Does whatever it needs to do to accomplish the action when asked including updating or creating one or more models</li>
</ul>


<p>Here&#8217;s a simplified example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">InvoiceJobOp</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Backend</span><span class="o">::</span><span class="no">Op</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mixins</span><span class="o">::</span><span class="no">AtomicOperation</span> <span class="c1"># all in same transaction</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:hours</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:job_id</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:job_id</span><span class="p">,</span> <span class="n">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">validate</span>  <span class="ss">:validate_hour</span>       <span class="c1"># hours given</span>
</span><span class='line'>  <span class="n">validate</span>  <span class="ss">:validate_assignment</span> <span class="c1"># tasker is assigned</span>
</span><span class='line'>  <span class="c1"># ... other checks</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span>
</span><span class='line'>    <span class="n">create_invoice!</span>    <span class="c1"># record hours and such</span>
</span><span class='line'>    <span class="n">generate_payment!</span>  <span class="c1"># pending payment transaction</span>
</span><span class='line'>    <span class="n">appointment_done!</span>  <span class="c1"># note that appointment completed</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">ongoing?</span>
</span><span class='line'>      <span class="n">schedule_next_appointment!</span> <span class="c1"># schedule next if more</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">complete_assignment!</span>       <span class="c1"># otherwise, no more</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">enqueue_background_workers!</span>  <span class="c1"># follow up later on stuff</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>No Side Effects</h3>

<p>When we followed the &#8220;Fat Model&#8221; pattern, we got what we wanted. This was usually methods in one of the models. Sometimes there were callbacks added. These were the most dangerous because they were happening on every <code>save</code>. Often, this added unnecessary side effects.</p>

<p>With the service object approach, it is very clear what is happening for the action at hand. When you &#8220;invoice a job,&#8221; you create the invoice, generate the payment, mark the appointment done, schedule the next appointment, and enqueue some background workers.</p>

<p>This certainty leads to less technical and product debt. When something new needs to be added to this action, it&#8217;s very clear where it goes.</p>

<h3>Errors</h3>

<p>Our <code>Op</code> class above does several model manipulations to the related invoices, appointments, etc. Each some of these does a <code>save</code> to something. Those <code>save</code> calls could raise errors. If any of those raise an error, then the <code>Op</code> itself will inherit it and it will be available on the <code>op.errors</code> method just like a normal <code>ActiveRecord</code> object.</p>

<p>This also allows chaining of operations. If there was a <code>ScheduleAppointmentOp</code> class, it could be used in the above <code>schedule_next_appointment!</code> method. If it raised an error, it would propagate to the <code>InvoiceJobOp</code>.</p>

<h3>Controllers</h3>

<p>Generally speaking, we have one <code>Op</code> per controller action that declares what it expects and manipulates the backend data as needed.</p>

<p>Here is a typical example from one of our controllers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">JobsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">confirm</span>
</span><span class='line'>    <span class="vi">@job</span> <span class="o">=</span> <span class="no">Job</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">authorize</span> <span class="vi">@job</span><span class="p">,</span> <span class="ss">:confirm?</span> <span class="c1"># authorization</span>
</span><span class='line'>    <span class="n">op</span> <span class="o">=</span> <span class="no">Organic</span><span class="o">::</span><span class="no">JobConfirmOp</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">op</span><span class="o">.</span><span class="n">submit!</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="vi">@job</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="c1"># perform action</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:show</span> <span class="c1"># render template</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>An action will typically do the following:</p>

<ul>
<li>Load a resource</li>
<li>Authorize the user is allowed do do an action</li>
<li>Perform the action with an operation (other things are in place to render and error if the op fails)</li>
<li>Render a template</li>
</ul>


<p>Note that this is clearly not a typical RESTful route. We&#8217;ve found that becomes less important when using this pattern. When the controllers are just wiring things up and are all a 5 lines or less, it feels like there is more flexibility.</p>

<p>It probably gets summed up something like this: wherever the fat (real work) is, that should be focused. For us, it&#8217;s not the controller because of service objects. The real work is 1 to 1 focused with the use case. If more was in the controllers, we&#8217;d probably be closer to the standard index, show, etc methods because of the focus concept.</p>

<h3>Sharing</h3>

<p>So we have pushed everything out closer to the user experience and away from the models. But what if something is needed in a few pieces of the experience?</p>

<p>A few ways we have done sharing:</p>

<ul>
<li>Two <code>Op</code>s can use a lower-level one or other type of class as noted above.</li>
<li>Two <code>Op</code>s can have a mixin with the shared behavior.</li>
<li>We can add a method to an applicable model. We tend to do this on simple methods that are interpreting the model data to answer a commonly-asked question or commonly-used display value.</li>
</ul>


<h3>Summary</h3>

<p>We have found that this approach provides a more maintainable and overall successful way of building Rails apps.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2017-02-24T00:00:00-08:00" pubdate data-updated="true">Feb 24<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2017/02/24/architecture-models/">Architecture: Models</a></h1>
	<div class="entry-content">
		<p>This is the first post in what I hope will be a series of articles about how we build things at <a href="https://www.taskrabbit.com">TaskRabbit</a>. Over time, we/I have internalized all kinds of lessons and patterns, but have never written them down explicitly and publicly. So let&#8217;s give that a try.</p>

<p>I thought we&#8217;d start with models. That&#8217;s what <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">Rails</a> calls database tables where each row is an instance of that model class.</p>

<p>Overall, we default to the following rules when designing the models in a system:</p>

<ul>
<li>Keep the scope small and based on decisions in the workflow</li>
<li>Use state machines to declare and lock in the valid transitions</li>
<li>Denormalize as needed to optimize use cases in the experience</li>
</ul>


<h3>Scope</h3>

<p>When designing a feature (or the whole app in its early days), you have to decide what the models represent. I&#8217;m calling that the &#8220;scope&#8221; of the model.</p>

<p>For example, most applications have a <code>User</code> model. What columns will it have? Stuff about the user, obviously. But what stuff? One of the tradeoffs to consider is <code>User</code> vs. <code>Account</code> vs. <code>Profile</code>. If you put everything about the user in the same table as the one that&#8217;s pointed to in many foreign keys through the system, there will be a performance impact.</p>

<p>So we put the most commonly needed items on every screen load in the <code>User</code> model and &#8220;extra&#8221; stuff in the <code>Profile</code>.</p>

<ul>
<li><code>User</code>: authentication, name, avatar, state</li>
<li><code>Profile</code>: address, average rating, bio information</li>
</ul>


<p>There are plenty of ways to cut this up into other models and move things around, but that&#8217;s what I mean about &#8220;scope&#8221; of a model.</p>

<h3>States</h3>

<p>State machines are built into the foundation of the system. Almost every model has a <code>state</code> column and an initial state. There are then valid transitions to other states.</p>

<p>For example, there is a <code>PaymentTransaction</code> model. It has an initial &#8220;pending&#8221; state that represents the time between when an invoice is submitted and when we charge the credit card. During this time, it can move to a &#8220;canceled&#8221; state if it should not happen. Or, if things go as planned, it can transition to a &#8220;settled&#8221; state. After that, if there is an issue of some sort, it would go to a &#8220;refunded&#8221; state. Notably, going from &#8220;pending&#8221; to &#8220;refunded&#8221; is <em>not</em> a valid transition.</p>

<div class="jumbotron">
<img src="/images/posts/architecture-models/states.png" class="bigPicture" />
</div>


<p>Creating these state and transitions preserves some sanity in the system. It&#8217;s a safety check. By asserting what is possible, we can (try to) prevent things that should not be possible.</p>

<h3>Nouns and Verbs</h3>

<p>The TaskRabbit marketplace creates a job that is sent to a Tasker. The Tasker can chat with the Client and can say they will do the job. Or they can decline. If they agree, they are officially assigned to the job and make an appointment. When they complete the job, they invoice the Client for the time worked. In most cases, it&#8217;s done at that point. In other cases, it is &#8220;ongoing&#8221; where they come back next week (to clean again, for example). At more or less any time, the whole thing can be canceled.</p>

<p>If given that description, you could come up with many possible model structures. They would all have a set of pros and cons, but many would work out just fine.</p>

<p>For example, you could have a <code>Job</code> model with these kinds of states: <code>invited</code>, <code>invitation_declined</code>, <code>assigned</code>, <code>appointment_made</code>, <code>invoiced</code>, <code>invoice_paid</code>, <code>canceled</code>, etc. Each would only allow the valid transitions as described above. You would also need the columns to represent the data: <code>client_id</code>, <code>tasker_id</code>, <code>appointment_at</code>, etc.</p>

<p>The main benefit of this approach is centrality. You can <code>SELECT * FROM jobs WHERE client_id = 42</code> and get all of that user&#8217;s situation. Over time, however, we came to value a more decentralized approach.</p>

<p>Now, the models of our system reflect its objects and decisions that the actors make about them. Each fork in the experience has a corresponding model with a simple state machine.</p>

<p>For example, the <code>Invitation</code> model is created first to note the decision the Tasker must make. It then either transitions to <code>accepted</code> or <code>declined</code>.  If accepted, it spawns an <code>Assignment</code>. It, in turn, can move to states like <code>completed</code> or <code>ongoing</code>.</p>

<div class="jumbotron">
<img src="/images/posts/architecture-models/invitations.png" class="bigPicture" />
</div>


<p>There is still the the <code>Job</code> model but it contains the &#8220;description&#8221; of the work to do and its <code>id</code> ties together the decision-based models.</p>

<h3>Trade-offs</h3>

<p>Everything is pros and cons. The decentralized approach has more global complexity (more objects and interactions) but less local complexity (simpler decisions, states).</p>

<p>It seemed to be the single, monolithic state machine that doomed the single <code>Job</code> model. Everything is fine as long as that&#8217;s the only path through the system. However, as soon as there is a new way for a Task to be assigned, we have a tangled web of states.</p>

<p>Not every task has the invitation pattern noted above. Some are &#8220;broadcast&#8221; to many Taskers at once and shown in a browse-able &#8220;Available Tasks&#8221; section in the their app. That&#8217;s a new fork in the experience. Ongoing tasks also create a state loop of sorts.</p>

<p>These cause the single state machine to get a bit tangled up, but is more easily handled in the decentralized approach. We can make a <code>Broadcast</code> model instead of an <code>Invitation</code> one. That can have its own set of states. Success in that local state machine can also spawn an <code>Assignment</code> and everything goes on as before.</p>

<h3>Denormalization</h3>

<p>To try and get the best of both worlds, we have also aggressively embraced a variety of forms of denormalization.</p>

<p>We actively try not to do SQL <code>JOIN</code>s for simplicity and performance reasons, but that is at odds with all these little models all over the place. So we have said it&#8217;s OK to have duplicate data. For example, each of these &#8220;decision&#8221; models have the <code>client_id</code>, <code>tasker_id</code>, and pricing information. It just gets passed along. This makes everything a local decision and queries very straightforward.</p>

<p>The big hole in the decentralized approach is to &#8220;get all my stuff&#8221; easily. For that we have different tactics, both of which are denormalization with use cases in mind.</p>

<p>On write to an object, we can update a central model with the current situation for that <code>Job</code>. For example, when an <code>Assignment</code> gets created, we recalculate and store data in two different tables. One for both the Tasker and the Client on what they should be seeing on their respective dashboards. Thus, the API call to &#8220;get all my stuff&#8221; uses one of those tables. That is done in the same transaction as the original write.</p>

<p>The other option is basically the same thing but for either less time-sensitive data or more complicated queries. We use a <a href="/blog/2015/04/02/queue-bus/">message bus</a> to observe changes. We then denormalize applicable data for a specific use case into a table or <a href="http://www.elastic.co">Elasticsearch</a>. For example, when an <code>Appointment</code> is created, we would update the Taskers availability schedule in the database. Updating this schedule would also trigger an update to our recommendation algorithm which uses Elasticsearch.</p>

<p>One important note: all of these denormalizations should be <a href="http://www.restapitutorial.com/lessons/idempotency.html">idempotent</a>. This allows us to recreate the whole thing from the source of truth or recover if any given event is dropped.</p>

<h3>Summary</h3>

<p>At TaskRabbit, we default to the following rules when designing the models in a system:</p>

<ul>
<li>Keep the scope small and based on decisions in the workflow</li>
<li>Use state machines to declare and lock in the valid transitions</li>
<li>Denormalize as needed to optimize use cases in the experience</li>
</ul>


<p>As always, these are just the default guidelines. In any given case, there may be a reason to deviate, but it would have to be clear why that case was special.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-12-02T00:00:00-08:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/alexa/'>alexa</a>, <a class='category' href='/blog/categories/bots/'>bots</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/voice/'>voice</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2016/12/02/amazon-alexa-rails/">Developing an Amazon Alexa Skill on Rails</a></h1>
	<div class="entry-content">
		<p>In March, we had a hack day at <a href="https://www.taskrabbit.com">TaskRabbit</a> and I did a demo of posting a task using a borrowed new-ish (at the time) Amazon <a href="https://www.amazon.com/echo">Echo</a> via <a href="https://developer.amazon.com/alexa">Alexa</a>. For the first time in a year, I made a new <a href="/blog/2014/02/11/rails-4-engines/">engine</a> that would handle all these new-fangled conversational UIs and bots and stuff.</p>

<p>The hack day came and went (I didn&#8217;t win) and this branch was just sitting there every time I did a <code>git branch</code> command. I only have a few there. Keep it clean, people! Then I saw the Cyber Monday deals on Amazon. I decided that it had sat there long enough so I dusted it off to try and bring it to the finish line.</p>

<p>I more or less started over, of course, because that&#8217;s how it goes. I thought I would document the process for anyone else on the trail.</p>

<div class="jumbotron">
  <image src="/images/posts/alexa/skill_store.png" class="bigPicture"/>
</div>


<h3>Alexa Sessions</h3>

<p>The <a href="https://developer.amazon.com/alexa-skills-kit">Alexa API</a> uses JSON to make requests and receive responses. Each session has a guid and (optional) user information.</p>

<p>The API has some cool session management tricks. You can <a href="https://developer.amazon.com/public/solutions/alexa/alexa-skills-kit/docs/alexa-skills-kit-interface-reference">return attributes</a> that will also get passed back on the next request. This effectively gives you &#8220;memory&#8221; of the previous parts of a conversation. I chose to not do this because I am hoping to use the same engine for other similiar interfaces. Instead I save the same stuff but to a table table using the session guid as the key. In ether case, it&#8217;s important to know where you&#8217;ve been and what you need to move forward.</p>

<p>In our case, we want to check the box that says there has to be a linked user. Because this is checked, the Alexa App will send them through an OAuth flow on our site. So we generate a token that maps to the user in our system and Alexa stores that token in hers. Side note: it&#8217;s hard to not fully personify Alexa after talking (arguing) back and forth all week.</p>

<h3>Hello World</h3>

<p>Alexa is given a single endpoint for a skill. It will POST the request to that route. So I added the line to the <code>routes.rb</code> file and sent it to a new <code>SkillsController</code>. It looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SkillsController</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">root</span>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="no">AlexaRubykit</span><span class="o">::</span><span class="no">Response</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">session_end</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">output</span><span class="o">.</span><span class="n">add_speech</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">render</span> <span class="n">json</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">build_response</span><span class="p">(</span><span class="n">session_end</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>





		
		<a href="/blog/2016/12/02/amazon-alexa-rails/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-11-10T00:00:00-08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/business/'>business</a>, <a class='category' href='/blog/categories/politics/'>politics</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2016/11/10/post-election/">Post Election</a></h1>
	<div class="entry-content">
		<p>I&#8217;ve been thinking a lot about the book <a href="https://en.wikipedia.org/wiki/The_City_%26_the_City"><em>The City &amp; the City</em></a> by China Miville. It describes a town in which two sets of people share the same physical space but do not acknowledge each other. For that matter, they are forbidden to do so.</p>

<p>I remember being surprised in 1992 when Bill Clinton won the election. I lived in Texas and everyone I knew was voting for Bush. Now, I live in California and the same thing snuck up on me again this week. There&#8217;s very little learning there.</p>

<p>But it&#8217;s not just where I live because technology has allowed a nation like in the book. Today, my Twitter feed is filled with anxiety, sadness, outrage, and very scared people. I am certain there are people nearby, not to mention in all those (many) red states, that have an exceptionally different feed: one full of hope, expectation, and triumph. And there is no connection between the two.</p>

<p>In that 1992 election, it was the economy (<a href="https://en.wikipedia.org/wiki/It%27s_the_economy,_stupid">stupid</a>) and the need for change. I&#8217;m certainly not a political analyst, but that rings just as true this week. All the jobs numbers are up over the last 8 years, but not everywhere and not for everyone. This has caused a rift.</p>

<h2>Forward</h2>

<p>Where do we go from here? I believe it&#8217;s best for each of use to use our talents and position as leverage to make a difference. In my case, I can help literally provide work in these areas of the country.</p>

<p><a href="https://www.taskrabbit.com">TaskRabbit</a> has been focusing on its largest markets because there is still plenty of room to grow there. And the whole thing is a hard problem. The focus helps, but our map is somewhat bare in Middle America. For me, this election is a kick in the pants to get there sooner than later.</p>

<p>The biggest fail there would be to believe that we can &#8220;save&#8221; people from on high by bestowing the magic of technology. Fortunately, even as the chief technologist at TaskRabbit, I understand that&#8217;s not where the value lies. It&#8217;s always been about neighbors helping neighbors. We&#8217;re just there to make the real-life connection.</p>

<p>I don&#8217;t know about you, but I think we could all really use a few more real-life connections at the moment.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-03-24T00:00:00-07:00" pubdate data-updated="true">Mar 24<span>th</span>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/react/'>react</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2016/03/24/react-native-android-launch/">React Native Android Launch</a></h1>
	<div class="entry-content">
		<p>Yesterday, we launched our updated Tasker app to our Android community. As noted <a href="/blog/2015/12/17/react-native-launch/">before</a> on the iOS launch, this is the app that Taskers use to get their work done. This completes our migration to <a href="https://facebook.github.io/react-native/">React Native</a>.</p>

<p>All of the credit goes to the team that made this happen, especially <a href="https://twitter.com/jrichardlai">JR</a> and <a href="http://jeremyeaton.co/">Jeremy</a>. It was a lot harder than expected to get everything working on both platforms and they showed great dedication and persistence.</p>

<h2>Approach</h2>

<p>The goal of the last release was for the iOS users to not even notice. Mission (more or less) accomplished! However, for this one, it didn&#8217;t make sense to fork the code by platform without a good reason. So admittedly, the app looks more like an iOS app and than an Android one. However, we did go screen by screen looking for places where Android-specific attention would help the user.</p>

<h2>Differences</h2>

<p>I&#8217;ll let JR do a followup to his <a href="/blog/2016/01/11/react-native-android/">previous post</a> of all the differences, but the biggest ones in my mind were the handling of the hardware back button and different pickers (date, for example) in the forms. The <code>Platform</code> directory strategy we had put in place during the first cycle worked out pretty well.</p>

<p>We also really struggled with getting push notifications right. This is key for our business and there were many more nuances on the Android platform to work out. We hope to publish what we came up with.</p>

<p>Of course, there was also the more extensive testing to do. Our Android pile:</p>

<div class="jumbotron">
  <img src="/images/posts/react-native-android-launch/pile.jpg" class="bigPicture"/>
</div>


<h2>Stats</h2>

<ul>
<li>App Javascript: 302 files with 21515 lines of code</li>
<li>Test Javascript: 47 files with 5708 lines of code</li>
<li>iOS Javascript: 19 files with 449 lines of code</li>
<li>Android Javascript: 19 files with 770 lines of code</li>
<li>Objective C: 17 files with 885 lines of code</li>
<li>Java: 15 files with 912 lines of code</li>
<li>iOS Config files: 18 files with 2538 lines of stuff</li>
<li>Android Config files: 16 files with 1106 lines of stuff</li>
<li>React Components: 124</li>
<li>Screens (addressable url patterns): 25</li>
<li>Avg. components per screen: 5</li>
<li>Dispatcher Events: 55</li>
<li>Shared JS (vs. Platform JS) percentage: 94%</li>
<li>JS (vs. Native ObjC/Java) percentage: 92%</li>
<li>Total shared code percentage: 87%</li>
<li>Total shared (including config) percentage: 75%</li>
</ul>


<h2>Next steps</h2>

<p>Now, we certainly didn&#8217;t do this engineering project because the tech was cool (even though it is). We did it to create a foundation that allows us to deliver value more effectively to our community. So that&#8217;s the next order of business. Time to get rolling! I estimate that we can ship features to both platforms at least twice as quickly with half the engineers than we had before.</p>

<p>Too long, but did read anyway: For you execs out there that somehow read this far (even past lines of code counts!), I&#8217;d say that we&#8217;ve found React Native to be at least 5x more productive than traditional mobile development.</p>

		
		
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-12-17T00:00:00-08:00" pubdate data-updated="true">Dec 17<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/react/'>react</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/12/17/react-native-launch/">React Native Launch</a></h1>
	<div class="entry-content">
		<p>This week, we launched our updated Tasker app to the community. This is not the app on the app store, but rather the one the Taskers use to get their work done. Functionally, not much has changed since the last release. But underneath, the app has been completely rewritten in <a href="https://facebook.github.io/react-native/">React Native</a>.</p>

<p>First and foremost, a huge congratulations needs to go out to the team, especially <a href="https://twitter.com/jrichardlai">JR</a>. I&#8217;ve never been on an engineering project that went as smoothly or was as fun as this one. So good!</p>

<h2>Prototype</h2>

<p>I started looking into React Native in the beginning of August. It&#8217;s a really great story. First of all, it&#8217;s <a href="https://facebook.github.io/react/">React</a>. I&#8217;ve now decided that&#8217;s just about the best thing out there. Secondly, I was 10x more productive than when developing a regular iOS app. Finally, there was a decent chance much of the code could be reused on Android. If every feature did not have to be developed twice, we could choose to develop twice as many features or have half the engineers work on something else.</p>

<p>I created a prototype to see if I thought it could work. The main concerns I had we around navigation, push notifications, other native features, data storage, and just getting the right project structure. More or less, I ended up with the <a href="https://github.com/taskrabbit/ReactNativeSampleApp">React Native Sample App</a> that we published. All of those things showed great promise or at least that they were possible.</p>


		
		<a href="/blog/2015/12/17/react-native-launch/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-11-08T00:00:00-08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/react/'>react</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
		
	</div>
	<h1 class="title"><a href="/blog/2015/11/08/react-native-integration-tests/">React Native Integration Tests</a></h1>
	<div class="entry-content">
		<p>Coming from a Rails <a href="http://guides.rubyonrails.org/testing.html">background</a>, we are very familiar with testing our code. While writing our new <a href="/blog/2015/09/21/react-native-example-app/">React Native app</a>, we found ourself missing a way to test it and ship with confidence. I&#8217;ve updated the <a href="https://github.com/taskrabbit/ReactNativeSampleApp">sample app</a> with the approach we are using for integration tests.</p>

<h2>Test Levels</h2>

<p>When thinking about what and how to test a React Native app, a few levels come to mind:</p>

<ul>
<li>Unit: Testing some pure Javascript object and it&#8217;s methods. Just run in Javascript.</li>
<li>Component: Testing a React component in isolation. You&#8217;d want to check its reaction to various state and props. Maybe run just in Javascript with heavy stubbing or in the simulator.</li>
<li>Integration: Testing a single screen or workflow in the &#8220;real&#8221; app. Run in the simulator or on the device.</li>
</ul>


<p>The approach shown here is the last one: integration testing. We did this one first because if you are only going to do one of the above, it is probably your best bet. By actually testing out what the user does, you get the highest level of &#8220;don&#8217;t screw it up&#8221; coverage.</p>

<p>There are some tradeoffs in this choice. They mostly stem from the fact that it&#8217;s the slowest (runtime) approach. Because of that, to test many edges cases takes f-o-r-e-v-e-r to actually run the tests. Something lower-level without the simulator would be much faster.</p>

<h2>Running Tests</h2>

<p>In the <a href="https://github.com/taskrabbit/ReactNativeSampleApp">sample app</a>, you follow these steps:</p>

<ul>
<li>Make sure you have the 9.0 simulators installed in XCode</li>
<li>Compile app for the test environment: <code>npm run compile:test</code></li>
<li>Launch simulator and tests: <code>npm test</code></li>
</ul>


<p>Running <code>npm test</code> will launch the simulator and the robots take over.</p>

<div class="jumbotron">
  <image src="/images/posts/react-native-integration-tests/follows.gif" class="bigPicture" />
</div>





		
		<a href="/blog/2015/11/08/react-native-integration-tests/" class="more-link">Read on &rarr;</a>
	</div>

</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    Brian Leonard

</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'bleonard';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37352049-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



		</div>
	</div>
</body>
</html>
